<!DOCTYPE html>

<html lang="en">
<head>

    <meta charset="UTF-8">

    <title> 
        水下电液作动器(EHA)综合显控系统
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="css/index.css">
    <script src="js/jquery-3.6.0.min.js"></script>
     <script src="js/echarts.min.js"></script>
    <script src="js/echart.int.js"></script>
    <script 
    src="js/jquery.js">    

    </script>
     
    <script>
        $(function () 
        {
            $('.myscroll').myScroll
            
            ({
                speed: 60, //数值越大，速度越慢
                rowHeight: 38 //li的高度
            });
        });

        $(document).ready(function () 
        {
            var whei = $(window).width()
            $("html").css({ fontSize: whei / 22 });
            $(window).resize(function () {
                var whei = $(window).width();
                $("html").css({ fontSize: whei / 22 })
            });
        });
    </script>

    <style>
        /* 设置SVG容器的样式 */
        .pipeline-container
        {
            
            width: 100%; /* 容器宽度自适应 */
            max-width: 800px; /* 设置最大宽度 */
            margin: 0 auto; /* 居中显示 */
        }

        /* 管道背景样式 */
        .pipeline-background
        {
            fill: none;
            stroke: #c3c3c3; /* 背景颜色 */
            stroke-width: 1.6
        }

        /* 管道轮廓样式 */
        .pipeline-red 
        {
            fill: none;
            stroke: #d9232397; /* 管道颜色 */
            stroke-width: 0.9;
        }
        .pipeline-blue
        {
            fill: none;
            stroke: #263abb97; /* 管道颜色 */
            stroke-width: 0.9;
        }

        /* 红色色调的流动液体（从前往后） */
        .flow-red-forward
        {
            fill: none;
            stroke: #ff0303;
            stroke-width: 0.9;
            stroke-dasharray: 4;
            animation: flowRedForward 2s linear infinite;
        }

        /* 红色色调的流动液体（从后往前） */
        .flow-red-backward 
        {
            fill: none;
            stroke: #ff0303;
            stroke-width: 0.9;
            stroke-dasharray: 4;
            animation: flowRedBackward 2s linear infinite;
        }

        .flow-red-wu 
        {
            fill: none;
            stroke: #ff0303;
            stroke-width: 0.9;
            stroke-dasharray: 0;
            animation: flowRedBackward 2s linear infinite;
        }
        .flow-blue-wu 
        {
            fill: none;
            stroke: #0303ff;
            stroke-width: 0.9;
            stroke-dasharray: 0;
            animation: flowBlueForward 2s linear infinite;
        }

        /* 蓝色色调的流动液体（从前往后） */
        .flow-blue-forward 
        {
            fill: none;
            stroke: #0303ff;
            stroke-width: 0.9;
            stroke-dasharray: 4;
            animation: flowBlueForward 2s linear infinite;
        }

        /* 蓝色色调的流动液体（从后往前） */
        .flow-blue-backward 
        {
            fill: none;
            stroke: #0303ff;
            stroke-width: 0.9;
            stroke-dasharray: 4;
            animation: flowBlueBackward 2s linear infinite;
        }

        /* 流动效果的关键帧 */
        @keyframes flowRedForward 
        {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: -40; }
        }
        @keyframes flowRedBackward
        {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: 40; }
        }

        /* 蓝色前后流动动画 */
        @keyframes flowBlueForward {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: -40; }
        }
        @keyframes flowBlueBackward {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: 40; }
        }




        .waveon 
        {
            position: absolute;
            top: 10%; /* 调整矩形在页面上的位置 */
            left: 5%; /* 调整矩形在页面上的位置 */
            width: 12%; /* 可自由调整 */
            height: 40%; /* 可自由调整 */

            --c: #2196F3;
            --w1: radial-gradient(100% 57% at top ,#0000 100%,var(--c) 100.5%) no-repeat;
            --w2: radial-gradient(100% 57% at bottom, var(--c) 100%,#0000 100.5%) no-repeat;
            background: var(--w1), var(--w2), var(--w1), var(--w2);
            border: 6px solid rgb(161, 161, 161); /* 例如，灰色虚线边框 */  
            background-size: 50.5% 100%;
            animation: m 1s infinite linear;
        }

        /* 波浪动画 */
        @keyframes m
        {
            0% { background-position-x: -200%, -100%, 0%, 100% }
            100% { background-position-x: 0%, 100%, 200%, 300% }
        }
















        .rectangle 
        {
            width: 6.5vw; /* 和 img10 的宽度保持一致 */
        height: 12.6vw; /* 和 img10 的高度保持一致 */
        position: absolute;
        top: 0.5rem; /* 使用相同的单位 */
        left: 48em; /* 使用相同的单位 */
            border: 6px solid #606060;
        }

        /* 红色部分样式 */
        .red-part 
        {
            background-color: red;
            width: 100%;
            position: absolute;
    
        }

        /* 蓝色部分样式 */
        .blue-part
        {
            background-color: blue;
            width: 100%;
            position: absolute;

        }
    </style>
</head>


<body>



    <div class="main">
        <div class="header">
            <div class="header-left fl" style="font-family: 'HYZhuziChaoran';">国家重点研发计划</div>
            <div class="header-center fl">
                <div class="header-title" style="font-family: 'HYZhuziChaoran';">
                    水下电液作动器(EHA)综合显控系统
                </div>
                <div class="header-img" id="animatedGif"></div>
            </div>
            <div class="header-right fl">
                <img src="assets/images/zju.png" alt="ZJU Logo" class="header-img-responsive"  />
            </div>
            <div class="header-bottom fl"></div>
        </div>
    </div>




    <div class="container" id="tongxun" style="display: none;">

        <div class="drag-bar">
            <!-- 图标 -->
   
            <div class="w-ext"></div>
        </div>
       <div class="content">
  <!-- 接收区域 -->
  <div class="receive">


<div class="filters">
  <div class="filter-container">
    <label for="idFilter">筛选ID:</label>
    <select id="idFilter">
      <option value="all">全部</option>
      <!-- JS 动态插入各 ID 选项 -->
    </select>
  </div>

  <div class="filter-container">
    <label for="typeFilter">筛选收发:</label>
    <select id="typeFilter">
      <option value="接收">接收</option>
      <option value="发送">发送</option>
    </select>
  </div>
</div>


    <table>
      <thead>
        <tr>
          <th class="col-2">ID</th>
          <th class="col-3">接收数据</th>
          <th class="col-2">数据解析</th>
          <th class="col-2">接收时间</th>
        </tr>
      </thead>
      <tbody id="TableBody">
        <!-- 数据行 -->
      </tbody>
    </table>
  </div>

  <!-- 发送区域 -->
  <div class="send">


                    <div class="input-container2" id="caninput-container-1" style="display: flex; top: 70% !important; right: 0px; ">
                        <label >设定ID</label>
                        <input id="IDDisplay" data-type="number" type="text" data-field="expectedid" placeholder="变量值" autocomplete="off">
                    </div>

                    <div class="input-container2" id="caninput-container-1" style="display: flex; top: 78% !important; right: 0px; ">
                        <label >设置数据</label>
                        <input id="IDDisplay" data-type="shiliu" type="text" data-field="expectedsenddate" placeholder="变量值" autocomplete="off">
                    </div>

                  <button id="fasongid" class="button-3d-1"
  style="top: 90%; left:5%; display: flex; position: absolute; transform: scale(0.5); transform-origin: top left;">
  发送数据
</button>
                    <div class="table-actions">
                    <button id="clearTable" class="button-3d-1"  style="top: 90%; left:35%; display: flex; position: absolute; transform: scale(0.5); transform-origin: top left;">清除列表</button>
                    <button id="exportTable" class="button-3d-1"  style="top: 90%; left:65%; display: flex; position: absolute; transform: scale(0.5); transform-origin: top left;">导出列表</button>
                    </div>



  </div>
</div>




        
    </div>


    <script src="js/index.js"></script>




    

    <div class="center">
        <div class="center-left fl">
            <div class="left-top">
                <!--<h1 id="ceshi">数据可视化</h1>-->
                <div class="title">状态信息</div>
                <div class="top-list">
                    <ul>
                        
                            <li>通信状态：</li>
                            <li><span id="connectionStatus" class="state-value"></span></li>
                
                     
                            <li>系统状态：</li>
                            <li><span id="systemStatus" class="state-value"></span></li>
              
                            <li>运行状态：</li>
                            <li><span id="RUNStatus" class="state-value"></span></li>



                            <li>限位状态：</li>
                            <li><span id="xianweiStatus" class="state-value"></span></li>
                        </tr>
                    </ul>
                </div>
                

            </div>
            <div class="left-cen">
                <div class="title">完成情况</div>
                <div class="top5">
                    <div class="top5-content">
                        <ul>
                            <li id="speedItem">
                                <div class="cicle" id="cicle1"></div>
                                <div class="li-content" id="content1">
                                    <span><b>速度</b></span>
                                    <span id="speedDisplay"style="color:  rgb(58, 237, 183);"><b>未接收</b></span>
                                    <span>mm/s</span>
                                </div>
                            </li>
                            <li id="pressureItem">
                                <div class="cicle" id="cicle2"></div>
                                <div class="li-content" id="content2">
                                    <span><b>压力</b></span>
                                    <span id="pressureDisplay" style="color: rgb(58, 237, 183);"><b>未接收</b></span>
                                    <span>MPA</span>
                                </div>
                            </li>
                            <li id="distanceItem">
                                <div class="cicle" id="cicle3"></div>
                                <div class="li-content" id="content3">
                                    <span><b>行程</b></span>
                                    <span id="distanceDisplay"style="color: rgb(255, 136, 0);"><b>未接收</b></span>
                                    <span>mm</span>
                                </div>
                            </li>
                        </ul>


                    <div class="progress-container">
                        <div class="progress-label">
                            <span class="title"id="progress-title">位置进度</span>
                            <span class="percentage" id="percentage-display">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-values">
                            <span id="actual-value-display">0/0</span>
                        </div>

                        <!-- <div class="progress-values" style="left: 50%;">
                            <span id="increment-display">0/0</span>
                        </div> -->
                    </div>
               



                    </div>





            </div>
            </div>

        </div>
        <div class="center-cen fl">
            <div class="cen-top">

                    <div class="date-container date5">
                        <div class="label"><b>实际电流A</b></div>
                        <div class="value" id="actual-current">0A</div>
                    </div>
                    
                    <div class="date-container date2">
                        <div class="label"><b>实际扭矩Nm</b></div>
                        <div class="value" id="actual-torque">0L/min</div>
                    </div>
                    
                    <div class="date-container date1">
                        <div class="label"><b>实际转速rpm</b></div>
                        <div class="value" id="actual-Rotationalspeed">0KW</div>
                    </div>

                    <div class="date-container date4">
                        <div class="label"><b>温度状况</b></div>
                        <div class="value" id="actual-power">正常</div>
                    </div>
                    <div class="date-container date3">
                        <div class="label"><b>实际速度MM/S</b></div>
                        <div class="value" id="actual-zhuansu">0mm/s</div>
                    </div>

                    

                                        <!-- <div class="date-container date4">
                        <div class="label"><b>电机温度℃</b></div>
                        <div class="value" id="actual-wendu">无</div>
                    </div> -->



                    




                    <div class="pipeline-container">
                        <svg width="800" height="500" viewBox="0 0 160 100" preserveAspectRatio="none" style="position: absolute; top: 0; left: 0;">
      <!-- 阀门到分流阀上 -->
<path class="pipeline-background" d="M 70.8 23.5 L 70.8 6  " />
 <path id="pipeline1" class="pipeline-red" d="M 70.8 23.5 L 70.8 6  " />
<path id="pipelineback1" class="flow-red-wu" d="M 70.8 23.5 L 70.8 6  " />
<!-- 分流阀上到匹配阀 -->

 <path class="pipeline-background" d=" M70.8 6.8 L48.8 6.8 L48.8 27.3 L43.2 27.3" />
<path  id="pipeline2"class="pipeline-red" d="M70.8 6.8 L48.8 6.8 L48.8 27.3 L42.7 27.3" />
 <path id="pipelineback2" class="flow-red-wu" d="M70.8 6.8 L48.8 6.8 L48.8 27.3 L42.7 27.3" />





      <!-- 电机到分流阀下 -->
      <path class="pipeline-background" d="M 70.8 28.5 L 70.8 47.5" />
      <path id="pipeline3"  class="pipeline-blue" d="M 70.8 28.5 L 70.8 47.5"/>
      <path id="pipelineback3" class="flow-blue-wu" d="M 70.8 28.5 L 70.8 47.5"/>

      <!-- 分流阀下到匹配阀 -->
      <path class="pipeline-background" d="M70.8 47 L48.8 47 L48.8 30  L43.2 30" />
      <path id="pipeline4"  class="pipeline-blue" d="M70.8 47 L48.8 47 L48.8 30  L43.2 30"/>
      <path id="pipelineback4" class="flow-blue-wu" d="M70.8 47 L48.8 47 L48.8 30  L43.2 30"/>

                            <!-- 到油箱 -->

 <path class="pipeline-background" d="M34.2 28.6 L26.2 28.6" />
  <path  id="pipeline5" class="pipeline-blue" d="M34.2 28.6 L26.2 28.6" />
<path id="pipelineback5" class="flow-blue-wu" d="M34.2 28.6 L26.2 28.6" />
<!-- 分流阀上液压缸 -->
<path class="pipeline-background" d=" M70.8 6.8 L 98.8 6.8 L 98.8 10.5 L 111.8 10.5" />
<path  id="pipeline6" class="pipeline-red" d=" M70.8 6.8 L 98.8 6.8 L 98.8 10.5 L 111.8 10.5" />
<path  id="pipelineback6"class="flow-red-wu" d=" M70.8 6.8 L 98.8 6.8 L 98.8 10.5 L 111.8 10.5" />

      <!-- 分流阀下到液压缸 -->
      <path class="pipeline-background" d="M70.8 47  L98.8 47  L98.8 42.3  L110.8  42.3" />
      <path  id="pipeline7" class="pipeline-blue" d="M70.8 47  L98.8 47  L98.8 42.3  L110.8  42.3"/>
      <path  id="pipelineback7" class="flow-blue-wu" d="M70.8 47  L98.8 47  L98.8 42.3  L110.8  42.3"/>




                        </svg>
                    </div>









             <div>
                <!-- 绝对定位的四个图片 -->
                <img src="assets/images/blue2.png" class="absolute-img img5" alt="Image 5" id="seeimage5"  >
                <img src="assets/images/red1.png" class="absolute-img img6" alt="Image 6" id="seeimage6">
                <img src="assets/images/GUANZI.png" class="absolute-img img1" alt="Image 1" id="seeimage1">
                <img src="assets/images/GANGZHU.png" class="absolute-img img2" alt="Image 2" id="seeimage2">
                <img src="assets/images/ZHENGTI2.png" class="absolute-img img3" alt="Image 3" id="seeimage3" >
                <img src="assets/images/GANGBI.png" class="absolute-img img4" alt="Image 4" id="seeimage4">


                <div class="rectangle" id="rectangle">
                    <div class="red-part" id="redPart"></div>
                    <div class="blue-part" id="bluePart"></div>
                </div>


                <div class="waveon"></div>

                

        
                <img src="assets/images/图片2.png" class="absolute-img img7" alt="Image 7" id="seeimage7">
                <img src="assets/images/图片3.png" class="absolute-img img8" alt="Image 8" id="seeimage8">
                <img src="assets/images/图片4.png" class="absolute-img img9" alt="Image 9" id="seeimage9" >
                <img src="assets/images/图片5.png" class="absolute-img img10" alt="Image 10" id="seeimage10">
                <img src="assets/images/图片4 - 副本.png" class="absolute-img img12" alt="Image 12" id="seeimage12" >
             </div>
            </div>

            <div class="cen-bottom">
                <div class="title">数据可视化</div>
                <div class="bottom-b"style="position: relative;">
                    <div id="export-container" >
                        <button id="export-button">导出数据</button>
                    </div>
                   <div id="export-container2" >
                        <button id="export-button2">通讯工具</button>
                    </div>
                  
                    

              
                    <div id="chart1" class="allnav"></div>
            <div id="chart2" class="allnav"></div>
                </div>

            </div>

        </div>

        
        <div class="center-right fr">
            <div class="right-top">
                <div class="title">控制面板</div>




                <div class="pressure-container button1">
                    <div class="pressure-label"><b>运行模式</b></div>
                    <div  class="pressure-value">
                        <select id="mode-select" onchange="updateMode()" style=" 
                             color: rgb(157, 248, 20);
                             background-color: rgb(134, 133, 133);
                            border: 2px solid rgb(255, 255, 255);
                            font-size: .25rem !important;
                            width: 1.8rem !important;
                            height: .5rem !important;">
                              <option value="位置">抚仙湖测试</option>
                            <option value="速度">速度控制</option>
                            <option value="压力">压力控制</option>
                                    <option value="耐久">耐久性测试</option>
                          
                        </select>     
                               
                    </div>  
                    <div class="input-container" id="input-container-1" style="display: none;  ">
                        <label >设定转速(rpm)</label>
                        <input id="expectedSpeedDisplay" data-type="number" type="text" data-field="expectedSpeed" placeholder="变量值" autocomplete="off">
                    </div>
                    <div class="input-container" id="input-container-5" style="display: none; top: 2.55rem !important; right: 0px;  ">
                        <label>最大转矩（N.m）</label>
                        <input data-type="number" type="text" data-field="expectAcceleration" placeholder="变量值" id="acceleration-inputzhuanju"autocomplete="off">
                    </div>





                    <div class="input-container" id="input-container-20" style="display: none; top: 3.55rem !important; right: 0px;   width: 2.55rem !important;  ">
                        <label>实验次数</label>
                        <input data-type="number" type="text" data-field="shiyancishu" placeholder="变量值" id="acceleration-input"autocomplete="off">
                    </div>

                    <div class="input-container" id="input-container-21" style="display: none; top: 3.55rem !important; right: 3rem !important;   width: 2.55rem !important; ">
                        <label>当前来回</label>
                        <input  data-type="number" type="text" data-field="shiyanlaihui" placeholder="变量值" id="acceleration-inputlaihui"autocomplete="off" readonly>
                    </div>


              <div class="input-container" id="input-container-22" style="display: none; top: 4.55rem !important; right: 3rem !important;   width: 2.55rem !important; ">
                        <label>回程判断</label>
                        <input data-type="number" type="text" data-field="shiyanzuidi" placeholder="变量值" id="acceleration-input"autocomplete="off" >
                    </div>

                    

              <div class="input-container" id="input-container-23" style="display: none; top: 5.55rem !important; right: 3rem !important;   width: 2.55rem !important; ">
                        <label>去程判断</label>
                        <input data-type="number" type="text" data-field="shiyanzuida" placeholder="变量值" id="acceleration-input"autocomplete="off" >
                    </div>





                    <div class="input-container" id="input-container-9" style="display: none; top: 3.55rem !important; right: 0px;   width: 2.55rem !important;  ">
                        <label>最大限位（mm）</label>
                        <input data-type="number" type="text" data-field="zuida" placeholder="变量值" id="acceleration-input"autocomplete="off">
                    </div>

                    <div class="input-container" id="input-container-10" style="display: none; top: 3.55rem !important; right: 3rem !important;   width: 2.55rem !important; ">
                        <label>最小限位（mm）</label>
                        <input data-type="number" type="text" data-field="zuixiao" placeholder="变量值" id="acceleration-input"autocomplete="off">
                    </div>
                    
                    <div class="input-container" id="input-container-2" style="display: none ; top:3.55rem !important; right: 0px;">
                        <label >设定压力(MPA)</label>
                        <input  id="expectedPressureDisplay" data-type="number" type="text" data-field="expectedPressure" placeholder="变量值" autocomplete="off">
                    </div>

                    <div class="input-container" id="input-container-8" style="display: none ; top: 2.55rem !important; right: 0px;  ">
                        <label >最大扭矩(NM)</label>
                        <input  id="expectedtorque" data-type="number" type="text" data-field="expectedtorque" placeholder="变量值" autocomplete="off">
                    </div>
                    
                    <div class="input-container" id="input-container-3" style="display: none;">
                        <label >设定定位点(mm)</label>
                        <input id="expectedDistanceDisplay" data-type="number" type="text" data-field="expectedDistance" placeholder="变量值" autocomplete="off">
                    </div>
                    <div class="input-container" id="input-container-4" style="display: none;">
                        <label>点动距离(mm)</label>
                        <input id="expectedTOPDistanceDisplay" data-type="number" type="text" data-field="expectedTOPDistance" placeholder="变量值" autocomplete="off">
                    </div> 
                    <!-- <div class="input-container" id="input-container-6" style="display: flex; top: 2.55rem !important; right: 0px;  ">
                        <label >限制速度 (mm/s)</label>
                        <input data-type="number" type="text" data-field="speedlimit" id="speedlimit-input" placeholder="变量值" autocomplete="off">
                    </div>     -->

                    <label id="switchone" for="toggle2" class="toggle2 switch1" style="display: none;">
                        <input type="checkbox" id="toggle2" class="toggle2-input" autocomplete="off">
                        <span class="toggle2-button">开启转速限制</span>
                      </label>

                      <label id="switchsix" for="toggle6" class="toggle2 switch4" style="display: none;">
                        <input type="checkbox" id="toggle6" class="toggle2-input" autocomplete="off">
                        <span class="toggle2-button">开启力位混控</span>
                      </label>

                      <!-- <label id="switchfour" for="toggle5" class="toggle2 switch4" style="display: flex;top: 3.7rem!important; left: -3.2rem!important; width:2.8rem!important; height: 0.8rem!important; position: absolute;">
                        <input type="checkbox" id="toggle5" class="toggle2-input" autocomplete="off">
                        <span class="toggle2-button">开启速度限制</span>
                      </label> -->


     


                      <label id="switchtwo" for="toggle4" class="toggle2 switch2" style="display: none;">
                        <input type="checkbox" id="toggle4" class="toggle2-input">
                        <span class="toggle2-button">开启点动</span>
                      </label>
                      <label id="switchthree" for="toggle3" class="toggle2 switch3" style="display: none;">
                        <input type="checkbox" id="toggle3" class="toggle2-input">
                        <span class="toggle2-button">开启定位</span>
                      </label>

                      <label id="switch11" for="toggle11" class="toggle2 switch5" style="display: none;">
                        <input type="checkbox" id="toggle11" class="toggle2-input">
                        <span class="toggle2-button">PID轨迹跟踪</span>
                      </label>
                      <label id="switch12" for="toggle12" class="toggle2 switch6" style="display: none;">
                        <input type="checkbox" id="toggle12" class="toggle2-input">
                        <span class="toggle2-button">ARC轨迹跟踪</span>
                      </label>


                      


                      <div class="button-container">
                        <button id="zhengxiang" class="button-3d-1" style="top: 4.75rem!important; left: -2.9rem!important; width: 100%; height: 40%; display: none;position: absolute;">切割</button>
                        <button id="fanxiang" class="button-3d-1" style="top: 5.75rem!important; left: -2.9rem!important; width: 100%; height: 40%; display: none;position: absolute;">复位</button>



                               <button id="zhengxiangqiege" class="button-3d-1" style="top: 4.75rem!important; left: -2.9rem!important; width: 100%; height: 40%; display: none;position: absolute;">正向切割</button>
                        <button id="fanxiangqiege" class="button-3d-1" style="top: 5.75rem!important; left: -2.9rem!important; width: 100%; height: 40%; display: none;position: absolute;">反向复位</button>
                   
                   
                        <button id="yuandian" class="button-3d-1" style="top: 3.6rem!important; left:-.3rem!important;  display: none;position: absolute;">返回原点</button>
                        <button id="guiling" class="button-3d-1" style="top: 3.6rem!important; left:-.3rem!important; display: none;position: absolute;">转速归零</button>
                    </div>
                    <div class="btn-holder" style="top: 5.0rem!important; left:0.9rem!important; width: 130%; height: 50%; position: absolute; ">
                        <button id="startBtn" class="btn btn-2 hover-slide-right" onclick="toggleExclusive(this, 'stopBtn'); updateStatus(this)">
                            <span>启动</span>
                        </button>
                    </div>
                    
                    <div class="btn-holder" style="top: 6rem!important; left: 0.9rem!important;  width: 130%; height: 50%;position: absolute;">
                        <button id="stopBtn" class="btn btn-2 hover-slide-right active" onclick="toggleExclusive(this, 'startBtn'); updateStatus(this)">
                            <span>停止</span>
                        </button>
                    </div>




                  
                         <div  class="pressure-value">
                            <select id="controlmode-select" onchange="updatecontrolMode()" style=" 
                                 color: rgb(157, 248, 20);
                                 background-color: rgb(134, 133, 133);
                                border: 2px solid rgb(255, 255, 255);
                                font-size: .25rem !important;
                                position: absolute;
                                top: .5rem !important;
                                height: .45rem !important;
                                left: -3.00rem !important;
                                width: 100%;
                                text-align: center; /* 使 select 中的文字居中 */
                                display: flex;
                                -webkit-appearance: none; /* 使 select 在某些浏览器上显示一致 */
                                height: 40%;">
                                <option value="无模式">请选择控制模式</option>
                                <option value="定位">速度切割</option>
                                <option value="点动">位置控制</option>
                            </select>     
                                   
                        </div>  




                            <div  class="pressure-value">
                                <select id="suanfamode-select" onchange="updatesuanfaMode()" style=" 
                                     color: rgb(157, 248, 20);
                                     background-color: rgb(134, 133, 133);
                                    border: 2px solid rgb(255, 255, 255);
                                    position: absolute;
                                    top: 10%;
                                    left: -130%;
                                    display: none;
                                    font-size: 110%;
                                    text-align: center; /* 使 select 中的文字居中 */
                                    -webkit-appearance: none; /* 使 select 在某些浏览器上显示一致 */
                                    width: 100%;
                                    height: 40%;">
                                    <option value="无算法">请选择控制算法</option>
                                    <option value="PID">PID控制</option>
                                    <option value="ARC">ARC控制</option>
                                </select>     
                                     
                                


                                
                            </div>  

                    <!-- <div class="toggle checkbox-wrapper-10" id="zhengfan" style="display: none;">
                        <input class="tgl tgl-flip" id="cb5" type="checkbox" onchange="toggleDirection()" />
                        <label class="tgl-btn" data-tg-off="速度正转" data-tg-on="速度反转" for="cb5"></label>
                    </div> -->
                </div>
            </div>

            <div class="right-bottom">
                <div class="title">故障报警</div>
<button id="clear-logs-btn" class="btnguzhang btnguzhang-clear"  style="top:-0.175rem  !important;  left: 2.175rem  !important; position:relative">清空所有报错</button>
<button id="export-logs-btn" class="btnguzhang btnguzhang-export"  style="top: -0.175rem  !important;  left: 2.175rem  !important; position:relative">导出所有报错</button>



                <div class="dangertext">


                    <table>
                        <thead>
                            <tr>
                                <th class="col-2">故障设备</th>
                                <th class="col-2">故障等级</th>
                                <th class="col-4">故障日记</th>
                                <th class="col-2">故障时间</th>
                            </tr>
                        </thead>
                        <tbody id="faultLogTableBody">
                            <!-- 故障记录将会被插入到这里 -->
                        </tbody>
                    </table>
                </div>
                

            </div>
        </div>
    </div>


</div>


<script src="js/jquery.min.js"></script>
<script src="js/echarts.min.js"></script>

<script src="js/fontscroll.js"></script>


<script>

        // 确保在 DOM 完全加载完成后执行

// 变量                          
const variables = {
    expectedSpeed: 0,
    expectedtorque:0,
    expectedDistance:-20,  // 确保初始化为数字类型
    expectAcceleration: 0,
    speedlimit:null,
    expectedTOPDistance: 20, // 设置步长为 20
    expectedPressure: 0,
    nowexpectedSpeed: 0,
    nowexpectedDistance: -20,
    nowexpectedPressure: 0,
    Actualcurrent: 0,
    Actualtorque: 0,
    Actualpower: 0,
    ActualRotationalspeed:0,
    limitAlarm: 0,
    errorbit:0,
    Actualzhuansu:0,
      Actualwendu:0,
    zuida:78,
    zuixiao:-20,
    expectedid: 0,
     expectedsenddate: "0x00", 
     shiyancishu:5000,
     shiyanlaihui:0,
       shiyanzuidi:36.06,
     shiyanzuida:223.41,
};



// 示例调用



        // 1秒后替换GIF图像为静态帧
        setTimeout(function() {
            // 获取元素并替换为静态帧图像
            var gifElement = document.getElementById("animatedGif");
         gifElement.style.background = 'url(./assets/images/第27帧.png) no-repeat center center';

            gifElement.style.backgroundSize = '100%';
        },900);




  
    // 如果需要定时更新数据（例如数据会变化）
//     const variables = {
//     expectedSpeed: 0,
//     expectedDistance:0,  // 确保初始化为数字类型
//     expectAcceleration: null,
//     speedlimit:null,
//     expectedTOPDistance: 20, // 设置步长为 20
//     expectedPressure: 0,
//     nowexpectedSpeed: 0,
//     nowexpectedDistance: 0,
//     nowexpectedPressure: 0,
//     Actualcurrent: 0,
//     Actualtorque: 0,
//     Actualpower: 0,
//     ActualRotationalspeed:0,
//     limitAlarm: 0,
//     errorbit:0,
// };

    function updateDisplay() {



        if(variables.expectedDistance>78)
{
variables.expectedDistance=78;
document.getElementById('expectedDistanceDisplay').innerText = 78;
 addFaultLog("推杆01号", "低", "设置范围超出最大范围，已设置78", formatTime(new Date()));
}

if(variables.expectedDistance<-20)
{
variables.expectedDistance=-20;
document.getElementById('expectedDistanceDisplay').innerText =-20;
addFaultLog("推杆01号", "低", "设置范围超出最小范围，已设置-20", formatTime(new Date()));
}
        // 更新压力显示的值，单位为 KN
        document.getElementById('pressureDisplay').innerText = variables.nowexpectedPressure.toFixed(2);
        document.getElementById('speedDisplay').innerText = variables.Actualzhuansu.toFixed(2);
        document.getElementById('distanceDisplay').innerText = variables.nowexpectedDistance.toFixed(2);
    
        // 更新实际电流、流量和功率显示的值

        // 更新预计值显示的值
    document.getElementById('expectedPressureDisplay').innerText = variables.expectedPressure;
    document.getElementById('expectedtorque').innerText = variables.expectedtorque;
    document.getElementById('expectedSpeedDisplay').innerText = variables.expectedSpeed;
    document.getElementById('expectedDistanceDisplay').innerText = variables.expectedDistance;
    document.getElementById('expectedTOPDistanceDisplay').innerText = variables.expectedTOPDistance;



        if (runStatus === "启动")
{
   
                if(currentMode === '位置')
        {
    // sendserialdate101();
        }
    
        // sendcandate011suanfa();

                if(currentMode === '位置'&&currentdistantState=== '定位')
        {
   sendserialdate031();
        }
        if(currentMode === '速度')
        {
        sendserialdate031();
        }
        sendserialdate011();
        // sendserialdate011yuandian();
        // sendserialdate011suanfa();

       naijiumode(); // 刷新页面显示
   

}
    }



    
let shenchupanduan=1;
let suohuipanduan=1;
let zerosuo=0;
let laihuipanduan=-1;
let onceonly=0;

let lastTriggerTime = 0;   // 上一次触发最大或最小的时间
const COOLDOWN = 10000;     // 3 秒防抖



function naijiupandaun() {
    console.log("当前位置:", variables.nowexpectedDistance); // 打印当前的距离

    // 假设位置在 36.06 到 223.41 之间时，设置实验次数为 -1
    if (variables.nowexpectedDistance <= 36.06) {
        console.log("当前位置 <= 36.06");

        variables.shiyanlaihui = 0;  // 设置实验次数为 0
        const lh = document.querySelector('input[data-field="shiyanlaihui"]');
        if (lh) {
            lh.value = variables.shiyanlaihui; // 更新页面上的实验次数
            console.log("更新实验次数为 0");
        }
    } 
    else if (variables.nowexpectedDistance >= 223.41) {
        console.log("当前位置 >= 223.41");

        variables.shiyanlaihui = 0;  // 设置实验次数为 0
        const lh = document.querySelector('input[data-field="shiyanlaihui"]');
        if (lh) {
            lh.value = variables.shiyanlaihui; // 更新页面上的实验次数
            console.log("更新实验次数为 0");
        }
    } 
    else {
        console.log("当前位置在 36.06 和 223.41 之间");

        variables.shiyanlaihui = -1;  // 设置实验次数为 -1
        const lh = document.querySelector('input[data-field="shiyanlaihui"]');
        if (lh) {
            lh.value = variables.shiyanlaihui; // 更新页面上的实验次数
            console.log("更新实验次数为 -1");
        }
    }
}




let zeroUntil = 0;
let zeroSent  = false;   // 本轮窗口是否已经发过0速
let normalSent = false;  // 窗口结束后是否已发过正常速度
// 放在外面做持久标志
let prevAtMin = false;
let prevAtMax = false;
let initialized = false; // 是否已经完成初次方向判定


let oncepadnaun=1;
let errortime = 0;
const TOL = 0.2; // 端点容差(按你的单位调)
 let maxdate = [0x00, 0xE0, 0xFF, 0xFF];  
 
 let mindate = [0x2E, 0x29, 0x00, 0x00];  


function updateExperimentCount() {
    const lh = document.querySelector('input[data-field="shiyanlaihui"]'); // 获取对应的input元素
    if (lh) {
        lh.value = variables.shiyanlaihui; // 更新页面上的实验次数
    }
}


function naijiumode() {
    // if (runStatus === "启动" && currentMode === "耐久") {
    //     const pos = Number(variables.nowexpectedDistance);
    //     const min = Number(variables.shiyanzuidi);
    //     const max = Number(variables.shiyanzuida);

    //     const atMin = pos <= (min + TOL);  // 判断当前位置是否接近最小值
    //     const atMax = pos >= (max - TOL);  // 判断当前位置是否接近最大值

    //     // 判断实验次数是否超过最大次数
    //     if (variables.shiyanlaihui > variables.shiyancishu) {
    //         console.log("实验次数已超过最大次数，停止测试");
    //         sendcandate101fuzhi(mindate);  // 发送停止信号或零速信号
    //         return;  // 停止进一步操作
    //     } else {
    //         // 如果当前位置小于最小设定值，发送最大值（远端位置）
    //         if (pos < min) {
    //             sendcandate101fuzhi(maxdate);  // 发送最大值（远端位置）
    //             //    console.log("触发最大" );
    //         }
    //         // 如果当前位置大于最大设定值，发送最小值（近端位置）
    //          if (pos > max) {
    //             sendcandate101fuzhi(mindate);  // 发送最小值（近端位置）
    //                 // console.log("触发最小" );
    //         }

    //         // 如果已经在设定范围内，并且没有触发过位置变化
    //         if (oncepadnaun === 1 && pos < max && pos > min) {
    //             sendcandate101fuzhi(mindate);  // 发送最小值（近端位置）
    //             oncepadnaun = 0;  // 重置为 0，防止重复触发
    //                 // console.log("触发中间" );
    //         }
    //     }
    //     updateExperimentCount();
    // }
}








naijiupandaun();


    setInterval(() => {
        updateDisplay();//这个包含了 naijiumode
        updateProgress();

    }, 10);








    // 指示状态



// 指示灯



</script>
    
<script>
    // 确保 DOM 完全加载后再执行

let lasterrorxianwie=0;
// 更新页面上的值
function updateActualValues() {
      
    if(variables.zuida<variables.nowexpectedDistance-1 || variables.nowexpectedDistance+1<variables.zuixiao)
{

if(lasterrorxianwie===0)
{
// addFaultLog("推杆01号", "低", "超出限位", formatTime(new Date()));
//    updatexianweiStatus(false);
   lasterrorxianwie=1;
}
 
}

    if(variables.zuida>variables.nowexpectedDistance-1 && variables.nowexpectedDistance+1>variables.zuixiao)
{
   updatexianweiStatus(true);
   lasterrorxianwie=0;
}
     document.getElementById("actual-current").textContent = variables.Actualcurrent.toFixed(2);
    document.getElementById("actual-torque").textContent = variables.Actualtorque.toFixed(2);
  //  document.getElementById("actual-power").textContent = variables.Actualpower.toString(16);
    document.getElementById("actual-Rotationalspeed").textContent = variables.ActualRotationalspeed.toFixed(2);
     document.getElementById("actual-zhuansu").textContent = variables.Actualzhuansu.toFixed(2);


}

// 模拟数据变化


// 定时更新界面
setInterval(function() {
 
    updateActualValues(); // 刷新页面显示
}, 100); // 每秒更新一次










    const connectionStatusElement = document.getElementById("connectionStatus");
    const systemStatusElement = document.getElementById("systemStatus");
     const xianweiStatusElement = document.getElementById("xianweiStatus");
    const RUNStatusElement = document.getElementById("RUNStatus");


function updateConnectionStatus(isConnected) {
    if (isConnected) {
        connectionStatusElement.textContent = "正常";
        // 恢复为默认的绿色（也可以直接留空让 CSS 接管）
        connectionStatusElement.style.color = "green";
    } else {
        connectionStatusElement.textContent = "未通讯";
        connectionStatusElement.style.color = "red";
    }
}


function updateSystemStatus(isConnected) {
    systemStatusElement.textContent = isConnected ? "OK" : "NULL";
    systemStatusElement.style.color = isConnected ? "green" : "red";
}

function updateRUNStatus(isConnected) {
    RUNStatusElement.textContent = isConnected ? "RUN" : "STOP";
    RUNStatusElement.style.color = isConnected ? "green" : "red";
}



function updatexianweiStatus(isConnected) {
    xianweiStatusElement.textContent = isConnected ? "正常" : "限位";
    xianweiStatusElement.style.color = isConnected ? "green" : "red";
}



    // 初始调用设置默认状态
  

   updatexianweiStatus(true);
    updateRUNStatus(false);
    updateSystemStatus(true);
    updateConnectionStatus(false);


  setInterval(() => {
  if (Date.now() - lastGoodTime > 3000) {
    updateConnectionStatus(false);
  }
}, 200);

    document.getElementById("toggle2").addEventListener("change", function() {


 var accelerationInput = document.getElementById("acceleration-inputzhuanju");


        // 如果复选框被选中，则移除 disabled 属性，使其可编辑，否则设置 disabled
        if (this.checked) {
            
            accelerationInput.disabled = false;
            accelerationInput.style.color = "#ff0000"; // 设置字体颜色为浅灰 
            
    
        } else {

        }
    });

    document.getElementById("toggle6").addEventListener("change", function() {
    const inputContainer3 = document.getElementById("input-container-3");

    // 如果复选框被选中，则显示 input-container-3
    if (this.checked) {
        inputContainer3.style.display = "flex"; // 显示 input-container-3
 
    } else {
        inputContainer3.style.display = "none"; // 隐藏 input-container-3
    }
});

let currentdistantState = '无模式';
let currentsuanfaState = '无算法';
function updatecontrolMode() {
    currentdistantState = document.getElementById("controlmode-select").value;


    if (currentdistantState === '点动') {
              resetButtons();
                   document.getElementById('input-container-1').style.display = 'none';
              document.getElementById('input-container-5').style.display = 'none';
            zhengxiangButton.style.display = 'block';
            fanxiangButton.style.display = 'block';
                  zhengxiangqiegeButton.style.display = 'none';
            fanxiangqiegeButton.style.display = 'none';
                      yuandianButton.style.display = 'block';
                         guilingButton.style.display = 'none';
            document.getElementById('input-container-3').style.display = 'flex';
            document.getElementById('input-container-4').style.display = 'none';
        } else if(currentdistantState === '定位') {
                  resetButtons();
            zhengxiangButton.style.display = 'none';
                 guilingButton.style.display = 'block';
                 yuandianButton.style.display = 'none';
            fanxiangButton.style.display = 'none';
                           zhengxiangqiegeButton.style.display = 'block';
            fanxiangqiegeButton.style.display = 'block';
            document.getElementById('input-container-3').style.display = 'none';
            document.getElementById('input-container-4').style.display = 'none';
             document.getElementById('input-container-1').style.display = 'flex';
              document.getElementById('input-container-5').style.display = 'flex';
        
        }
        else if(currentdistantState === '无模式') 
        {
                  resetButtons();
                         document.getElementById('input-container-1').style.display = 'none';
              document.getElementById('input-container-5').style.display = 'none';
            zhengxiangButton.style.display = 'none';
            fanxiangButton.style.display = 'none';
                       guilingButton.style.display = 'none';
               yuandianButton.style.display = 'none';
            document.getElementById('input-container-3').style.display = 'none';
            document.getElementById('input-container-4').style.display = 'none';
              zhengxiangqiegeButton.style.display = 'none';
            fanxiangqiegeButton.style.display = 'none';
        }


}
function updatesuanfaMode() {
    currentsuanfaState = document.getElementById("suanfamode-select").value;
}




// 模式选择、、、、、、、、、、、、、、、、、、、、、、、、、

    let currentMode = '位置';


    document.getElementById("cicle3").classList.add("active-cicle");
    document.getElementById("content3").classList.add("active-content");


    function updateMode() {
    currentMode = document.getElementById("mode-select").value;
    console.log("当前模式:", currentMode);
    console.log("当前模式:", variables);
    const progressTitle = document.getElementById("progress-title");

    // 清除所有元素上的激活类
    document.getElementById("cicle1").classList.remove("active-cicle");
    document.getElementById("content1").classList.remove("active-content");
    document.getElementById("cicle2").classList.remove("active-cicle");
    document.getElementById("content2").classList.remove("active-content");
    document.getElementById("cicle3").classList.remove("active-cicle");
    document.getElementById("content3").classList.remove("active-content");
  
    // 重置所有数值显示的颜色
    document.getElementById("speedDisplay").style.color = "rgb(58, 237, 183)";
    document.getElementById("pressureDisplay").style.color = "rgb(58, 237, 183)";
    document.getElementById("distanceDisplay").style.color = "rgb(58, 237, 183)";

        // 隐藏正向和反向按钮
           guilingButton.style.display = 'none';
        controlmodeButton.style.display='none';
        suanfamodeButton.style.display='none';
        zhengxiangButton.style.display = 'none';
        fanxiangButton.style.display = 'none';
        yuandianButton.style.display = 'none';
                          zhengxiangqiegeButton.style.display = 'none';
            fanxiangqiegeButton.style.display = 'none';
    // 隐藏所有输入容器和开关
    document.querySelectorAll('.input-container').forEach(container => {
        container.style.display = 'none';
    });
    document.querySelectorAll('.toggle2').forEach(container => {
        container.style.display = 'none';
    });

    // 根据选择的模式添加激活类并设置颜色
    if (currentMode === "速度") {
resetButtons();
    
  
          variables.expectedSpeed =0;
          variables.expectAcceleration =0;
          variables.zuida =78;
                variables.zuixiao -20;
        updatecandate()
        document.getElementById("cicle1").classList.add("active-cicle");
        document.getElementById("content1").classList.add("active-content");
        document.getElementById('input-container-1').style.display = 'flex';
        document.getElementById('input-container-5').style.display = 'flex';

        document.getElementById('input-container-9').style.display = 'flex';
          document.getElementById('input-container-10').style.display = 'flex';
        progressTitle.textContent = "转速进度";
        document.getElementById('switchone').style.display = 'none';
        document.getElementById('zhengfan').style.display = 'flex';
        // 设置速度数值为橙色
        document.getElementById("speedDisplay").style.color = "rgb(255, 136, 0)";
        document.getElementById('guiling').style.display = 'flex';

    } else if (currentMode === "压力") {
 resetButtons();   
         variables.expectedSpeed =0;
          variables.expectAcceleration =0;
      variables.zuida =78;
                variables.zuixiao =-20;
        updatecandate()
        document.getElementById("cicle2").classList.add("active-cicle");
        document.getElementById("content2").classList.add("active-content");
        document.getElementById('input-container-2').style.display = 'flex';
        document.getElementById('input-container-8').style.display = 'flex';
        document.getElementById('switchsix').style.display = 'flex';
        progressTitle.textContent = "压力进度";
        document.getElementById('zhengfan').style.display = 'none';
        document.getElementById('guiling').style.display = 'none';
        togglePointhunhe.checked = false;
        // 设置压力数值为橙色
        document.getElementById("pressureDisplay").style.color = "rgb(255, 136, 0)";

    } else if (currentMode === "位置") {
        resetButtons();
         variables.expectedSpeed =0;
          variables.expectAcceleration =0;
           variables.zuida =78;
                variables.zuixiao =-20;
        updatecandate()
        document.getElementById("cicle3").classList.add("active-cicle");
        document.getElementById("content3").classList.add("active-content");
        yuandianButton.style.display = 'none';
        // document.getElementById('input-container-6').style.display = 'flex';
        progressTitle.textContent = "位置进度";
        
        if (currentdistantState === '点动') {

            document.getElementById('input-container-3').style.display = 'none';
            document.getElementById('input-container-4').style.display = 'flex';
            yuandianButton.style.display = 'block';
        } else if(currentdistantState === '定位') {

            document.getElementById('input-container-3').style.display = 'flex';
            document.getElementById('input-container-4').style.display = 'none';
            guilingButton.style.display = 'block';
        }
        else if(currentdistantState === '无模式') 
        {
       
            document.getElementById('input-container-3').style.display = 'none';
            document.getElementById('input-container-4').style.display = 'none';

        }

 
        // document.getElementById('switchfour').style.display = 'flex';
          document.getElementById('controlmode-select').style.display = 'flex';
          document.getElementById('suanfamode-select').style.display = 'none';



  
        
        document.getElementById('zhengfan').style.display = 'none';
        document.getElementById('guiling').style.display = 'none';
   
        console.log("当前状态:", currentdistantState);

        // 设置行程数值为橙色
        document.getElementById("distanceDisplay").style.color = "rgb(255, 136, 0)";
    }else if(currentMode=== "耐久")
    {
      document.getElementById("cicle3").classList.add("active-cicle");
    document.getElementById("content3").classList.add("active-content");
      resetButtons();
           progressTitle.textContent = "当前位置";
   
                document.getElementById('input-container-20').style.display = 'flex';
        document.getElementById('input-container-21').style.display = 'flex';
               document.getElementById('input-container-22').style.display = 'flex';
        document.getElementById('input-container-23').style.display = 'flex';
    }
}




// 键盘输入设置
// 键盘输入设置
let previousValue = ''; // 用于存储编辑前的值
let currentInput = null; // 当前正在编辑的输入框

// 获取所有带 data-field 属性的输入框
const inputs = document.querySelectorAll('input[data-field]');

inputs.forEach(input => {
    // 初始化输入框的值
    const field = input.getAttribute('data-field');
    input.value = variables[field];

    input.addEventListener('focus', () => {
        previousValue = input.value.trim(); // 记录当前输入框的值
        currentInput = input; // 设置当前输入框为正在编辑的输入框
    });

    // 处理按键事件
    input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // 阻止默认的换行
            const field = input.getAttribute('data-field'); // 获取字段名
            let newValue = input.value.trim(); // 获取新值

            // 校验输入类型
            if (input.getAttribute('data-type') === 'number') {
                if (isNaN(newValue)) {
                    alert('请只输入数字！');
                    return; // 不更新变量
                } else {
                    newValue = parseFloat(newValue).toString(); // 使用 parseFloat 保留小数
                }
            }
if (input.getAttribute('data-type') === 'shiliu') {
    let parsedValue;
    let originalValue = newValue; // 保留原输入

    newValue = newValue.trim().toLowerCase();

    if (newValue.startsWith('0x')) {
        parsedValue = parseInt(newValue, 16);
    } else if (/^[0-9a-f]+$/i.test(newValue)) {
        parsedValue = parseInt(newValue, 16);
        originalValue = '0x' + newValue; // 补全0x前缀
    } else {
        alert('请输入有效十六进制数，例如 0x1A 或 FF');
        return;
    }

    if (isNaN(parsedValue)) {
        alert('解析失败，请检查输入格式');
        return;
    }

    variables[field] = parsedValue; // 保存为十进制值

    input.value = originalValue; // ✅ 保留用户输入（补全0x前缀）
    console.log(variables);
    currentInput = null;
    return;
}




            variables[field] = newValue; // 更新变量
            input.value = newValue; // 更新输入框内容
            console.log(variables); // 打印更新后的变量
            currentInput = null; // 重置当前输入框
        }
    });

    // 处理失去焦点事件
    input.addEventListener('blur', () => {
        if (currentInput !== input) return; // 如果不是当前输入框，不处理
        if (input.value.trim() === '') {
            input.value = '未定义'; // 如果为空，恢复为未定义
            variables[input.getAttribute('data-field')] = '未定义'; // 同时更新变量
        } else {
            input.value = previousValue; // 恢复为编辑前的值
        }
        currentInput = null; // 重置当前输入框
    });
});


// 进度显示函数
/// 更新进度条和实况显示

let increment = 0;
function updateProgress() {
    const progressFill = document.getElementById("progress-fill");
    const percentageDisplay = document.getElementById("percentage-display");
    const actualValueDisplay = document.getElementById("actual-value-display");
   // const incrementDisplay = document.getElementById("increment-display");

    let percentage = 0;
    let current = 0;
    let target = 0;
  
    let actualIncrement = 0;

    // 根据模式设置 current 和 target，并强制转换为数字
    if (currentMode === '速度') {
        current = Number(variables.ActualRotationalspeed);
        target = Number(variables.expectedSpeed);
    } else if (currentMode === '位置') {
        current = Number(variables.nowexpectedDistance);
        target = Number(variables.expectedDistance);
    } else if (currentMode === '压力') {
        current = Number(variables.nowexpectedPressure);
        target = Number(variables.expectedPressure);
    }
 else if (currentMode === '耐久') {
    
         current = Math.abs(variables.nowexpectedDistance);
         target  = Math.abs(variables.expectedDistance);

    }
  
    // 确保 target 和 current 为有效数字
    // 由于你保证输入值总是数字，这部分逻辑不再需要

    // 判断目标位置是否发生变化
    if (target !== previousTarget) {
        // 如果目标位置变化，计算目标增程
        increment = target - previousTarget;  // 目标增程
      
        previousTarget=target;
     
    }

    actualIncrement =increment-(target-current) ;

    // 计算实际增程：当前值与上次实际值之间的差
    

    // 计算误差
    const error = Math.abs(actualIncrement - increment);

    // 如果误差小于等于 0.1，将百分比设为 100%
    if (error <= 0.1) {
        incrementPercentage = 100;
    } else {
        // 计算实际值/目标值的百分比
       
        incrementPercentage = Math.max((actualIncrement / increment) * 100, 0);

    }

    // 计算实际增程 / 目标增程的百分比
    
  
    percentage = target !== 0 ? (current / target) * 100 : 0;


    // 更新进度条宽度，不超过 100%
    progressFill.style.width = `${Math.min(incrementPercentage, 100)}%`;
    percentageDisplay.textContent = increment === 0 ? "100%" : `${Math.round(incrementPercentage)}%`;

    // 更新实际/目标显示
    actualValueDisplay.textContent = target === 0 
        ? `${current.toFixed(2)}/0.00` 
        : `${current.toFixed(2)}/${target.toFixed(2)}`;

    // 更新增程显示
    // incrementDisplay.textContent = `${actualIncrement.toFixed(2)}/${increment.toFixed(2)}`;

    // 存储当前的目标位置和实际位置，以便下次计算增程
    previousTarget = target;
    previousCurrent = current;
}

// 存储上一个目标位置和实际值
let previousTarget = 0;
let incrementPercentage = 0;

// 每秒更新进度条
setInterval(updateProgress, 30); // 每秒更新一次








function addReceiveData(id, data, parsed, time) {
  const tableBody = document.getElementById("TableBody");

  // 创建行
  const newRow = document.createElement("tr");
  newRow.setAttribute("data-id", id); // 用于筛选
  newRow.setAttribute("data-type", "接收"); // 添加 data-type 标记接收数据

  // ID
  const idCell = document.createElement("td");
  idCell.textContent = id;
  newRow.appendChild(idCell);

  // 接收数据
  const dataCell = document.createElement("td");
  dataCell.textContent = data;
  newRow.appendChild(dataCell);

  // 数据解析
  const parsedCell = document.createElement("td");
  parsedCell.textContent = parsed;
  newRow.appendChild(parsedCell);

  // 时间
  const timeCell = document.createElement("td");
  timeCell.textContent = time;
  newRow.appendChild(timeCell);

  // 插入到表格顶部
  tableBody.insertBefore(newRow, tableBody.firstChild);

  // 更新下拉选项
  updateIDFilterOptions(id);
}



function addSendData(id, data, parsed, time) {
  const tableBody = document.getElementById("TableBody");
  const newRow = document.createElement("tr");

  newRow.setAttribute("data-id", id);
  newRow.setAttribute("data-type", "发送");

  newRow.innerHTML = `
    <td>${id}</td>
    <td>${data}</td>
    <td>${parsed}</td>
    <td>${time}</td>
  `;

  tableBody.insertBefore(newRow, tableBody.firstChild);
  updateIDFilterOptions(id);
}


function updateIDFilterOptions(id) {
  const select = document.getElementById("idFilter");
  const idStr = id.toString(); // 转为字符串
  const options = Array.from(select.options).map(opt => opt.value);

  if (!options.includes(idStr)) {
    const option = document.createElement("option");
    option.value = idStr;
    option.textContent = idStr;
    select.appendChild(option);

    
  }
}



document.getElementById("idFilter").addEventListener("change", function() {
  const selectedID = this.value;
  const rows = document.querySelectorAll("#TableBody tr");

  rows.forEach(row => {
    const rowID = row.getAttribute("data-id");
    if (selectedID === "all" || rowID === selectedID) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
});


function filterTableRows() {
  const selectedID = document.getElementById("idFilter").value;
  const selectedType = document.getElementById("typeFilter").value;
  const rows = document.querySelectorAll("#TableBody tr");

  rows.forEach(row => {
    const rowID = row.getAttribute("data-id");
    const rowType = row.getAttribute("data-type");

    const idMatch = (selectedID === "all" || rowID === selectedID);
    const typeMatch = (selectedType === "all" || rowType === selectedType);

    if (idMatch && typeMatch) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
}
document.getElementById("idFilter").addEventListener("change", filterTableRows);
document.getElementById("typeFilter").addEventListener("change", filterTableRows);





// 故障报警、、、、、、、
function addFaultLog(device, level, log, time) {
    // 获取日志表体
    const logTableBody = document.getElementById("faultLogTableBody");

    // 创建新的行
    const newRow = document.createElement("tr");

    // 创建每一列并设置内容
    const deviceCell = document.createElement("td");
    deviceCell.textContent = device;
    newRow.appendChild(deviceCell);

    const levelCell = document.createElement("td");
    levelCell.textContent = level;
    newRow.appendChild(levelCell);

    const logCell = document.createElement("td");
    logCell.textContent = log;
    newRow.appendChild(logCell);

    const timeCell = document.createElement("td");
    timeCell.textContent = time;
    newRow.appendChild(timeCell);

    // 将新行插入到最上方
    logTableBody.insertBefore(newRow, logTableBody.firstChild);
}


function formatTime(date) {
    const minutes = date.getMinutes().toString().padStart(2, '0');
    const seconds = date.getSeconds().toString().padStart(2, '0');
    return `${minutes}.${seconds}`;
}



// 清空表格所有行
function clearFaultLogs() {
  const tbody = document.getElementById("faultLogTableBody");
  tbody.innerHTML = "";
}

function exportFaultLogs() {
  const rows = Array.from(document.querySelectorAll("#faultLogTableBody tr"));
  if (rows.length === 0) {
    alert("当前没有任何报错记录可导出。");
    return;
  }

  // 1. 构造 CSV 内容
  let csv = "设备,级别,日志,时间\n";
  rows.forEach(tr => {
    const cols = Array.from(tr.querySelectorAll("td")).map(td =>
      `"${td.textContent.replace(/"/g, '""')}"`
    );
    csv += cols.join(",") + "\n";
  });

  // 2. 在最前面加 UTF-8 BOM
  const bom = '\uFEFF';  
  const csvWithBom = bom + csv;

  // 3. 用 blob 触发下载
  const blob = new Blob([csvWithBom], { type: "text/csv;charset=utf-8;" });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href     = url;
  // 建议用 .csv 后缀
  a.download = `fault_logs_${new Date().toISOString()}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


// 挂载到按钮
document
  .getElementById("clear-logs-btn")
  .addEventListener("click", clearFaultLogs);

document
  .getElementById("export-logs-btn")
  .addEventListener("click", exportFaultLogs);



let lastlimitError = null;  // 初始值设为 null 或其他值，表示未检测到错误

function limiterror() {
    // 只有当 limitAlarm 状态变化时才记录日志
    if (variables.limitAlarm !== lastlimitError) {
        lastlimitError = variables.limitAlarm;  // 更新 lastlimitError 为当前状态

        // 根据不同的 limitAlarm 状态记录不同的日志
        if (variables.limitAlarm === 1) {
            // addFaultLog("推杆1号", "低", "伸出限位", formatTime(new Date()));
        } else if (variables.limitAlarm === 2) {
            // addFaultLog("推杆1号", "低", "缩回限位", formatTime(new Date()));
        } else {
            // 处理其他状态，例如：0（未限位）
        }
    }
}


// 点动定位按钮

// 初始状态设置为“定位”


// 获取两个切换开关的输入元素

const togglePointhunhe = document.getElementById("toggle6");


// 获取正向和反向按钮
const controlmodeButton = document.getElementById("controlmode-select");
const suanfamodeButton = document.getElementById("suanfamode-select");
const zhengxiangButton = document.getElementById("zhengxiang");
const zhengxiangqiegeButton = document.getElementById("zhengxiangqiege");
const fanxiangqiegeButton = document.getElementById("fanxiangqiege");

const fanxiangButton = document.getElementById("fanxiang");
const yuandianButton = document.getElementById("yuandian");
const guilingButton = document.getElementById("guiling");
const expectedDistanceInput = document.querySelector('input[data-field="expectedDistance"]');
const expectedSpeedInput = document.querySelector('input[data-field="expectedSpeed"]');

// 设置初始状态


// 更新状态显示函数
function updateStateDisplay() {
    console.log("当前状态:", currentdistantState);
}


zhengxiangButton.addEventListener("click", function() {


    variables.expectedDistance =34;
   document.getElementById('expectedDistanceDisplay').value = variables.expectedDistance;
        let canId = [0x01, 0x01]; 
        let data = [0x40, 0x19,0x00,0x00]; 
                 sendRS485(canId, data);


   

}

);

// 反向按钮点击事件
fanxiangButton.addEventListener("click", function() {
 

    variables.expectedDistance =-20;
   document.getElementById('expectedDistanceDisplay').value = variables.expectedDistance;
  

        let canId = [0x01, 0x01]; 
        let data = [0x40, 0x19,0x00,0x00]; 
                 sendRS485(canId, data);
}

);

yuandianButton.addEventListener("click", function() {
 

    variables.expectedDistance =-20;
   document.getElementById('expectedDistanceDisplay').value = variables.expectedDistance;
  
      let canId = [0x01, 0x01]; 
        let data = [0x40, 0x19,0x00,0x00]; 
                 sendRS485(canId, data);
}

);



guilingButton.addEventListener("click", function() {


    variables.expectedSpeed =0;
       variables.expectAcceleration =0;
   document.getElementById('expectedSpeedDisplay').value = variables.expectedSpeed;
   document.getElementById('acceleration-inputzhuanju').value = variables.expectAcceleration;


 if (runStatus === "启动") {

 sendserialdate031guiling();

}
});

zhengxiangqiegeButton.addEventListener("click", function() {

    variables.expectedDistance =78;
   document.getElementById('expectedDistanceDisplay').value = variables.expectedDistance;
    variables.expectedSpeed =1500;
       variables.expectAcceleration =4;
   document.getElementById('expectedSpeedDisplay').value = variables.expectedSpeed;
   document.getElementById('acceleration-inputzhuanju').value = variables.expectAcceleration;


 if (runStatus === "启动") {

 sendserialdate031guiling();

}
});

fanxiangqiegeButton.addEventListener("click", function() {

    variables.expectedDistance =-20;
   document.getElementById('expectedDistanceDisplay').value = variables.expectedDistance;
    variables.expectedSpeed =-1500;
       variables.expectAcceleration =4;
   document.getElementById('expectedSpeedDisplay').value = variables.expectedSpeed;
   document.getElementById('acceleration-inputzhuanju').value = variables.expectAcceleration;


 if (runStatus === "启动") {

 sendserialdate031guiling();

}
});

let yuandianzhiwei =0;


document.getElementById("yuandian").addEventListener("click", function() {
    // 将 expectedDistance 设置为 0
    variables.expectedDistance =-20;
    yuandianzhiwei =1;
    // 可以根据需要打印更新后的变量值
    console.log("expectedDistance 已更新为: " + variables.expectedDistance);
    expectedDistanceInput.value = variables.expectedDistance;
});


document.getElementById("guiling").addEventListener("click", function() {
    // 将 expectedDistance 设置为 0
    variables.expectedSpeed = 0;
    
    // 可以根据需要打印更新后的变量值
    console.log("expectedDistance 已更新为: " + variables.expectedSpeed);
    expectedSpeedInput.value = variables.expectedSpeed;
});


document.getElementById("fasongid").addEventListener("click", function() {
  let hexStr = variables.expectedsenddate;

  if (typeof hexStr === "number") {
    hexStr = hexStr.toString(16); // 转为十六进制字符串
  }

  hexStr = hexStr.trim().toLowerCase();

  // 移除 0x 前缀
  if (hexStr.startsWith("0x")) {
    hexStr = hexStr.slice(2);
  }

  // 确保长度为偶数
  if (hexStr.length % 2 !== 0) {
    hexStr = "0" + hexStr;
  }

  // 解析为字符串数组
  const data = [];
  for (let i = 0; i < hexStr.length && data.length < 8; i += 2) {
    data.push("0x" + hexStr.substr(i, 2).toUpperCase());
  }

  // 补齐至 8 bytes
  while (data.length < 8) {
    data.push("0x00");
  }

  const idValue = variables.expectedid;
  console.log("发送 id:", idValue, " data:", data);

  sendCAN(idValue, data);

  addSendData(
     idValue, // ID
    data, // data 字符串数组
    `发送数据`, // 解析内容
    formatTime(new Date()) // 当前时间
    
);
updateIDFilterOptions(idValue); // 需要补充这行
});


document.getElementById("clearTable").addEventListener("click", function() {
  const tableBody = document.getElementById("TableBody");
  tableBody.innerHTML = "";
});
document.getElementById("exportTable").addEventListener("click", function() {
  const rows = document.querySelectorAll("#TableBody tr");
  if (rows.length === 0) {
    alert("当前没有任何记录可导出。");
    return;
  }

  let csv = "ID,数据,解析,时间\n";
  rows.forEach(row => {
    const cols = row.querySelectorAll("td");
    const rowData = Array.from(cols).map(td => `"${td.textContent.trim()}"`);
    csv += rowData.join(",") + "\n";
  });

  // 创建 Blob 下载
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `列表导出_${new Date().toISOString()}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
});

function cleartables(){
  const tableBody = document.getElementById("TableBody");
  tableBody.innerHTML = "";
}



function toggleExclusive(button, otherButtonId) {
  
    if (button.classList.contains("active")) {
        return;
    }

    button.classList.add("active");

    // 获取并禁用另一个按钮
    const otherButton = document.getElementById(otherButtonId);
    otherButton.classList.remove("active");
}
let runStatus = "停止"; // 初始状态

function updateStatus(button) {
    // 更新状态变量为 "启动" 或 "停止"
    runStatus = button.id === "startBtn" ? "启动" : "停止";

    
    // 执行相应的操作
    if (runStatus === "启动") {
    updateRUNStatus(true);
    // sendserialdate011open()
    sendserialdate011();

        // sendcandate011suanfa();


        if(currentMode === '速度')
        {
        sendserialdate031();
        }


} else {
    sendserialdate011();
    updateRUNStatus(false);

}
}





function resetButtons() {
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    // 例如重置为停止状态
    toggleExclusive(stopBtn, "startBtn");
    updateStatus(stopBtn);
   
}




// 初始化方向和输入框
function initializeDirection() {
    const speedInput = document.getElementById("speedInput");
    const directionCheckbox = document.getElementById("cb5");

    // 设置方向开关的初始状态，并确保输入框显示正数
    directionCheckbox.checked = variables.expectedSpeed < 0;
    speedInput.value = Math.abs(variables.expectedSpeed);
}

// 切换正转/反转
function toggleDirection() {
    const speedInput = document.getElementById("speedInput");
    const directionCheckbox = document.getElementById("cb5");

    // 切换方向并更新 expectedSpeed 的值
    variables.expectedSpeed = directionCheckbox.checked ? -Math.abs(variables.expectedSpeed) : Math.abs(variables.expectedSpeed);
    speedInput.value = Math.abs(variables.expectedSpeed); // 始终显示为正数
    console.log("当前设定速度:", variables.expectedSpeed);
}

// 监听输入框的变化，自动更新按钮状态
document.getElementById("speedInput").addEventListener("input", (event) => {
    const inputValue = Math.abs(parseFloat(event.target.value)) || 0; // 确保输入框仅接收正数
    const directionCheckbox = document.getElementById("cb5");

    // 根据方向设置 expectedSpeed 的正负
    variables.expectedSpeed = directionCheckbox.checked ? -inputValue : inputValue;
    event.target.value = inputValue; // 保持输入框为正数

    console.log("实时设定速度:", variables.expectedSpeed);
});

// 初始化界面
initializeDirection();

// 绑定切换方向的事件
document.getElementById("cb5").addEventListener("change", toggleDirection);






</script>
<script>







// 动画移动
// 液压缸
// 定义 PID 控制变量


function pidControl() {
 
    
    // 使用 PID 控制输出更新图像位置
    updateImagePosition(variables.nowexpectedDistance);

}
const image2 = document.getElementById('seeimage2');
    const image8 = document.getElementById('seeimage6');
    const image9 = document.getElementById('seeimage5');

    const image10 = document.getElementById('seeimage10');
function updateImagePosition(position) {


  // 把 [20,250] 映射到 [0,100] 的百分比
  const MIN_POS = -20;
  const MAX_POS = 78;
  const clamped = Math.min(Math.max(position, MIN_POS), MAX_POS);
  const ratio   = (clamped - MIN_POS) / (MAX_POS - MIN_POS);
  const pct     = ratio * 100;  // 0 ~ 100


    // 计算图像平移距离
  image2.style.transform = `translateX(${pct*0.34}%)`;

  // B) image8 正向宽度缩放，width: pct%（相对于父容器宽度）



  // ratio = pct/100
  image8.style.width = `${ 30- pct*0.2}%`;


  // C) image9 反向缩放宽度
  image9.style.width = `${ 13+ pct*0.2}%`;




  // D) image10 垂直平移，用 translateY(%)
  image10.style.transform = `translateY(${pct*0.85-35}%)`;

  if (redOnTop) {
    redPercentage = Math.min(pct, 100);
  } else {
    redPercentage = Math.max(100 - pct , 0);
  }
  // 把 redPercentage 应用到红色层上，比如：
  // redLayer.style.width = `${redPercentage}%`;

}


function updateonce(){
  
 
    pidControl();


}

setInterval(updateonce, 10); // 每秒检查一次


setInterval(cleartables, 30000); // 每秒检查一次
setInterval(limiterror, 1000); // 每秒检查一次


// 液压缸红蓝变化
let previousDistance = variables.nowexpectedDistance; // 初始化上一个值
const pipeline1 = document.getElementById("pipeline1");
    const pipelineback1 = document.getElementById("pipelineback1");
    const pipeline2 = document.getElementById("pipeline2");
    const pipelineback2 = document.getElementById("pipelineback2");
    const pipeline3 = document.getElementById("pipeline3");
    const pipelineback3 = document.getElementById("pipelineback3");
    const pipeline4 = document.getElementById("pipeline4");
    const pipelineback4 = document.getElementById("pipelineback4");
    const pipeline5 = document.getElementById("pipeline5");
    const pipelineback5 = document.getElementById("pipelineback5");
    const pipeline6 = document.getElementById("pipeline6");
    const pipelineback6 = document.getElementById("pipelineback6");
    const pipeline7 = document.getElementById("pipeline7");
    const pipelineback7 = document.getElementById("pipelineback7");




function updateImageSources() {
const nowexpectedDistance = variables.nowexpectedDistance; // 获取当前值

    if(currentMode === '位置')
{
    const nowexpectedDistance = variables.nowexpectedDistance; // 获取当前值
    const expectedDistance = variables.expectedDistance; // 获取当前值


    // 计算变化量
     delta = expectedDistance - nowexpectedDistance;
}

    if(currentMode === '速度'||currentMode === '耐久')
{
    const nowexpectedspeed = variables.ActualRotationalspeed; // 获取当前值
  if(nowexpectedspeed>=0)
  {
    delta=1;
  }
    if(nowexpectedspeed<=0)
  {
    delta=-1;
  }
}

   

    const image7 = document.getElementById("seeimage7");

    if (delta >0) {
        // 如果变化量为正
 
    
        image8.src = 'assets/images/blue2.png'; // 红色图像地址
        image9.src = 'assets/images/red1.png'; // 蓝色图像地址
        image7.style.transition = "transform 2s"; // 设置 2 秒的平滑移动
        image7.style.transform = `translateY(22%)`; // 执行移动

// 替换前先移除旧类，再添加新类
// 替换前先移除旧类，再添加新类
pipeline1.classList.remove(pipeline1.className.baseVal);
pipeline1.classList.add("pipeline-red");

pipeline2.classList.remove(pipeline2.className.baseVal);
pipeline2.classList.add("pipeline-red");

pipeline3.classList.remove(pipeline3.className.baseVal);
pipeline3.classList.add("pipeline-blue");

pipeline4.classList.remove(pipeline4.className.baseVal);
pipeline4.classList.add("pipeline-blue");

pipeline5.classList.remove(pipeline5.className.baseVal);
pipeline5.classList.add("pipeline-blue");

pipeline6.classList.remove(pipeline6.className.baseVal);
pipeline6.classList.add("pipeline-red");

pipeline7.classList.remove(pipeline7.className.baseVal);
pipeline7.classList.add("pipeline-blue");

pipelineback1.classList.remove(pipelineback1.className.baseVal);
pipelineback1.classList.add("flow-red-forward");

pipelineback2.classList.remove(pipelineback2.className.baseVal);
pipelineback2.classList.add("flow-red-wu");

pipelineback3.classList.remove(pipelineback3.className.baseVal);
pipelineback3.classList.add("flow-blue-backward");

pipelineback4.classList.remove(pipelineback4.className.baseVal);
pipelineback4.classList.add("flow-blue-forward");

pipelineback5.classList.remove(pipelineback5.className.baseVal);
pipelineback5.classList.add("flow-blue-forward");

pipelineback6.classList.remove(pipelineback6.className.baseVal);
pipelineback6.classList.add("flow-red-forward");

pipelineback7.classList.remove(pipelineback7.className.baseVal);
pipelineback7.classList.add("flow-blue-backward");


    } else if (delta < 0) {
        // 如果变化量为负
    
     
        image8.src = 'assets/images/red1.png'; // 蓝色图像地址
        image9.src = 'assets/images/blue2.png'; // 红色图像地址

        image7.style.transition = "transform 2s"; // 设置 2 秒的平滑移动
        image7.style.transform = `translateY(-22%)`; // 执行移动
        pipeline1.classList.remove(pipeline1.className.baseVal);
pipeline1.classList.add("pipeline-blue");

pipeline2.classList.remove(pipeline2.className.baseVal);
pipeline2.classList.add("pipeline-blue");

pipeline3.classList.remove(pipeline3.className.baseVal);
pipeline3.classList.add("pipeline-red");

pipeline4.classList.remove(pipeline4.className.baseVal);
pipeline4.classList.add("pipeline-red");

pipeline5.classList.remove(pipeline5.className.baseVal);
pipeline5.classList.add("pipeline-blue");

pipeline6.classList.remove(pipeline6.className.baseVal);
pipeline6.classList.add("pipeline-blue");

pipeline7.classList.remove(pipeline7.className.baseVal);
pipeline7.classList.add("pipeline-red");

pipelineback1.classList.remove(pipelineback1.className.baseVal);
pipelineback1.classList.add("flow-blue-backward");

pipelineback2.classList.remove(pipelineback2.className.baseVal);
pipelineback2.classList.add("flow-blue-forward");

pipelineback3.classList.remove(pipelineback3.className.baseVal);
pipelineback3.classList.add("flow-red-forward");

pipelineback4.classList.remove(pipelineback4.className.baseVal);
pipelineback4.classList.add("flow-red-wu");

pipelineback5.classList.remove(pipelineback5.className.baseVal);
pipelineback5.classList.add("flow-blue-forward");

pipelineback6.classList.remove(pipelineback6.className.baseVal);
pipelineback6.classList.add("flow-blue-backward");

pipelineback7.classList.remove(pipelineback7.className.baseVal);
pipelineback7.classList.add("flow-red-forward");

    }
    if (delta > 0) {
        // 如果变化量为正
        redOnTop = true;
    // 更新上一个值
    }    else if (delta < 0) {
        // 如果变化量为负
        redOnTop = false;
    }
     
    previousDistance = nowexpectedDistance; 

}

// 在某个时机调用此函数

setInterval(updateImageSources, 10); // 每秒检查一次


// 不允许缩放、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、
document.addEventListener('mousewheel', function (e) {
 
 e = e || window.event;

 if ((e.wheelDelta && event.ctrlKey) || e.detail) {

   event.preventDefault();

 }

}, {

 capture: false,

 passive: false

});

document.addEventListener('keydown', function (event) {

 if ((event.ctrlKey === true || event.metaKey === true)

   && (event.keyCode === 61 || event.keyCode === 107

     || event.keyCode === 173 || event.keyCode === 109

     || event.keyCode === 187 || event.keyCode === 189)) {

   event.preventDefault();

 }

}, false);

let redPercentage = 3; // 控制红色部分的初始高度百分比
let redOnTop = true; // 控制红色在上方或下方

function updateRectangle() {
    const redPart = document.getElementById('redPart');
    const bluePart = document.getElementById('bluePart');

    // 确保 redPart 和 bluePart 元素存在
    if (redPart && bluePart) {
        if (redOnTop) {
            // 红色在上方
            redPart.style.top = '0';
            bluePart.style.top = redPercentage + '%';
            redPart.style.height = redPercentage + '%';
           
            bluePart.style.height = (100 - redPercentage) + '%';
           
        } else {
            // 红色在下方
            bluePart.style.top = '0';
            redPart.style.top = (100 - redPercentage) + '%';
            redPart.style.height = redPercentage + '%';
         
            bluePart.style.height = (100 - redPercentage) + '%';
          
        }
    }
}

    setInterval(updateRectangle, 100); // 每秒检查一次


    document.addEventListener('DOMContentLoaded', function() {
        const button = document.getElementById('myButton');
        if (button) {
            button.addEventListener('click', function() {
                alert('Button clicked!');
            });
        } else {
            console.log('Button not found!');
        }
    });



    const CAN_API_URL = "http://localhost:8080"; 

    let lastSentData = null;  // 保存上次发送的数据
    async function sendCAN(id, data) {

        if (lastSentData && lastSentData.id === id && JSON.stringify(lastSentData.data) === JSON.stringify(data)) {
            // console.log("数据未发生变化");
            
        }
        console.log("发送的数据:", {
        id: `0x${id.toString(16).toUpperCase()}`, // 以十六进制格式打印 ID
        data: data.map(byte => `0x${byte.toString(16).padStart(2, '0').toUpperCase()}`) // 以十六进制格式打印数据字节
    });

        try {
            const response = await fetch("http://localhost:8080/send_can", {
                method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
                body: JSON.stringify({ id, data })  // 转换数据为 JSON 格式
            });

            // 读取响应并检查其格式
            const text = await response.text();  // 获取响应文本
            console.log("Response text:", text);  // 打印响应文本
            const result = text ? JSON.parse(text) : {}; 

            if (response.ok) {
                console.log("CAN 信号发送成功", result);
            } else {
                console.error("CAN 信号发送失败", result);
            }

            // 更新 lastSentData，保存当前发送的数据
            lastSentData = { id, data };

        } catch (error) {
            console.error("发送失败:", error);
        }
    }

    function checkDistance(nowexpectedDistance, expectedDistance, tolerance = 0.01) {
        if (Math.abs(nowexpectedDistance - expectedDistance) <= tolerance) {
            // 如果接近，设置为 1
            return 1;
        } else {
            // 如果不接近，保持为 0
            return 0;
        }
    }

    let lastReceivedId = null;  // 保存上一次接收到的 id
    let lastReceivedData = null;  // 保存上一次接收到的数据
    let lastGoodTime = 0;
 
    async function receiveCAN() {
        try {
            const response = await fetch("http://localhost:8080/receive_can", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
            });

            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }

            const result = await response.json();
            // 判断接收到的id是否为0
            if (result.id === 0) {
                // console.log("尚未接收到有效的 CAN 数据");
                return;  // 如果id为0，表示没有接收到有效数据
            }

            // 比较数据是否发生变化
            if (result.id === lastReceivedId && JSON.stringify(result.data) === JSON.stringify(lastReceivedData)) {
                // console.log("数据未发生变化，跳过更新");
                return;  // 数据没有变化，跳过处理
            }

            // 更新 lastReceivedId 和 lastReceivedData
            lastReceivedId = result.id;
            lastReceivedData = result.data;
            updateConnectionStatus(true);
            lastGoodTime = Date.now();
           


            // 根据 id 解析数据
            if (result.id === 0x012) {
            
       
                let tempDistance=0;
                let tempspeed=0;
      
                tempDistance = (result.data[0]) | (result.data[1] << 8) | (result.data[2] << 16) | (result.data[3] << 24);
                let raw = (result.data[4]) | (result.data[5] << 8);  // 0–65535
               
                if (raw & 0x8000) {
                raw = raw - 0x10000;  
                }
                tempspeed = raw;
              
                
                variables.Actualzhuansu = tempspeed;  // 合并转速高位和低位
                // console.log("原始十六进制值: " + tempDistance.toString(16)); // 打印十六进制值
                //  console.log("原始十六进制值: " + tempspeed.toString(16)); // 打印十六进制值
               
                
                let nowexpectedDistance1 = tempDistance / 100.0;
                variables.nowexpectedDistance=nowexpectedDistance1-32;
            
                 variables.limitAlarm = result.data[6];  // 0:未限位, 1:伸出限位, 2:缩回限位
                
const parsed = `距离: ${(variables.nowexpectedDistance).toFixed(2)} mm, 速度: ${variables.Actualzhuansu} rpm, 限位: ${variables.limitAlarm}`;
addReceiveData(
  "0x" + result.id.toString(16).toUpperCase(),
  result.data.map(d => "0x" + d.toString(16).toUpperCase()),
  parsed,
  formatTime(new Date())
);


                
            } else if (result.id === 0x032) {
      
                // 解析 0x032 数据格式
                const rpmHigh = result.data[0];
                const rpmLow = result.data[1];
                variables.Actualtorque  = result.data[2] / 10; // 实际扭矩*10 Nm
                variables.errorbit  = result.data[3]; // 故障位
                variables.Actualcurrent  = result.data[4] * 10; // 电流峰值*10 A
                const voltageHigh = result.data[5];
                const voltageLow = result.data[6];

                variables.ActualRotationalspeed = (rpmHigh * 256) + rpmLow-3200;  // 合并转速高位和低位
                // variables.Actualpower = (voltageHigh * 256) + voltageLow; 电压解析

            // 检查每个故障位
                    // if (variables.errorbit & 0x01) { // 位0: 过流保护
                    // addFaultLog("推杆01号", "高", "电机过流", formatTime(new Date()));
                    // }

                    // if (variables.errorbit & 0x02) { // 位1: 过载保护
                    // addFaultLog("推杆01号", "高", "电机过载", formatTime(new Date()));
                    // }

                    // if (variables.errorbit & 0x04) { // 位2: 电机过温报警
                    // addFaultLog("推杆01号", "高", "电机过温", formatTime(new Date()));
                    // }

                    // if (variables.errorbit & 0x08) { // 位3: 驱动器过温报警
                    // addFaultLog("推杆01号", "高", "电机过温", formatTime(new Date()));
                    // }
// 构造限位状态文本（如果 applicable）
let parsed = `转速: ${variables.ActualRotationalspeed} rpm, 扭矩: ${variables.Actualtorque.toFixed(1)} Nm, 电流: ${variables.Actualcurrent.toFixed(1)} A, 故障位: ${variables.errorbit}`;

addReceiveData(
  "0x" + result.id.toString(16).toUpperCase(),
  result.data.map(byte => "0x" + byte.toString(16).toUpperCase()),
  parsed,
  formatTime(new Date())
);

            }
            
        } 
        
        
        
        catch (error) {
            console.error("Error fetching CAN data:", error);
        }
    }





    let lastSentData101 = [0x00, 0x00];  // 用于记录上次 0x101 发送的数据
  
    let lastSentData011 = [0x00, 0x00,0x00,0x00];  // 用于记录上次 0x101 发送的数据
    let lastSentData011suanfa = [0x00, 0x00,0x00,0x00];  // 用于记录上次 0x101 发送的数据

    let lastSentData031 = [0x00, 0x00,0x00,0x00];  // 用于记录上次 0x031 发送的数据
     let lastSentData031fu = [0x00, 0x00,0x00,0x00];  // 用于记录上次 0x031 发送的数据
    let lastSentData031zero = [0x00, 0x00,0x00,0x00];  // 用于记录上次 0x031 发送的数据
    let lastSentData101fuzhi = [0x00, 0x00,0x00,0x00];  // 用于记录上次 0x031 发送的数据
     
let  startflag=0;
    //0x011编码、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、
    function sendserialdate011()
    {
        let canId = [0x00, 0x11];   
        let data = [0x00, 0x00];  


        if (runStatus === "启动") {
            data[0] = 0x01;  // 如果是启动，设置为 0x01
        } 
    

    if( currentdistantState === '点动')
    {
        data[1]=0X0c  ;
    }

    if( currentdistantState === '定位'||currentMode === "耐久")
    {
        data[1]=0X0c  ;
    }

    if( currentdistantState === '定位'||currentMode === "速度") 
    {
        data[1]=0X01  ;
    }


    if(runStatus ==="停止")
    {
        data[1]=0X00  ;
    }

    if (JSON.stringify(data) !== JSON.stringify(lastSentData011)) {
        
    
                sendRS485(canId, data);
       

addSendData(
  "0x" + canId.toString(16).toUpperCase(),
  data.map(d => "0x" + d.toString(16).toUpperCase()),
  `sendcandate011 指令 | runStatus: ${runStatus}, currentdistantState: ${currentdistantState}, currentMode: ${currentMode}`,
  formatTime(new Date())
);

            lastSentData011 = [...data];
        }


        // if (startflag===1) {
        
        //     for (let i = 0; i < 10; i++) {
        //         sendRS485(canId, data);
        //     }
        
        //     lastSentData011 = [...data];
        //     startflag=0;
        // }

    }
    //0x011编码、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、
    function sendserialdate011yuandian()
    {
        let canId = [0x00, 0x11]; 
        let data = [0x00, 0x00];  


        if (runStatus === "启动") {
            data[0] = 0x01;  // 如果是启动，设置为 0x01
        } 

        data[1]=0X0A  ;
    

    if(runStatus ==="停止")
    {
        data[1]=0X00  ;
    }


        if(yuandianzhiwei===1)
        {
         
                sendRS485(canId, data);
          
            yuandianzhiwei=0;
                            addSendData(
        "0x" + canId.toString(16).toUpperCase(),
        data.map(d => "0x" + d.toString(16).toUpperCase()),
        "回到原点",
        formatTime(new Date())
    );
        }
    


    }
    //0x011算法编码、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、
    function sendserialdate011suanfa()
    {
        let canId = [0x00, 0x11];  
        let data = [0x00, 0x00];  


        if (runStatus === "启动") {
            data[0] = 0x01;  // 如果是启动，设置为 0x01
        } else {
            data[0] = 0x00;  // 如果不是启动，设置为 0x00
        }
  

    if( currentsuanfaState === 'PID')
    {
        data[1]=0X02  ;
    }

    if( currentsuanfaState === 'ARC')
    {
        data[1]=0X03  ;
    }

    if(runStatus ==="停止")
    {
        data[1]=0X00  ;
    }

    if (JSON.stringify(data) !== JSON.stringify(lastSentData011suanfa)) {
        
  
                sendRS485(canId, data);
         
                                    addSendData(
        "0x" + canId.toString(16).toUpperCase(),
        data.map(d => "0x" + d.toString(16).toUpperCase()),
        "",
        formatTime(new Date())
    );
            lastSentData011suanfa = [...data];
        }

    }

    //0x011编码、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、
    function sendserialdate011close()
    {
        let canId = [0x00, 0x11];   
        let data = [0x01, 0x00];  
   
                sendCAN(canId, data);
         
                                        addSendData(
        "0x" + canId.toString(16).toUpperCase(),
        data.map(d => "0x" + d.toString(16).toUpperCase()),
        "停止",
        formatTime(new Date())
    );
    }
 //0x011编码、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、
    function sendserialdate011open()
    {
        let canId = [0x00, 0x11]; 
        let data = [0x01, 0x00];  
          startflag=1;
 
                sendRS485(canId, data);
       
                                        addSendData(
        "0x" + canId.toString(16).toUpperCase(),
        data.map(d => "0x" + d.toString(16).toUpperCase()),
        "启动",
        formatTime(new Date())
    );
    }
    //0x101编码、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、
    function sendserialdate101()
    {
        let canId = [0x01, 0x01]; 
        let data = [0x00, 0x00,0x00,0x00]; 
        let hexValue1 =  variables.expectedDistance+34;
        if(hexValue1<=0)
    {
        hexValue1=0;
    }
        let hexValue =  (hexValue1*100).toString(16).padStart(8, '0');  // 转换为十六进制并确保是 8 位
   

    data = [
        parseInt(hexValue.slice(6, 8), 16),   // 低字节
        parseInt(hexValue.slice(4, 6), 16),   // 第二字节
        parseInt(hexValue.slice(2, 4), 16),   // 第三字节
        parseInt(hexValue.slice(0, 2), 16)    // 高字节
    ];
    if (JSON.stringify(data) !== JSON.stringify(lastSentData101)) {
            // 发送 CAN 数据
         
                sendRS485(canId, data);
          


addSendData(
  "0x" + canId.toString(16).toUpperCase(), // ID
  data.map(d => "0x" + d.toString(16).toUpperCase()), // data 字符串数组
  `当前设定位置:\n${variables.expectedDistance}`, // ✅ 正确换行
  formatTime(new Date()) // 当前时间
);

            // 更新上次发送的数据
            lastSentData101 = [...data];
        }

    }



function sendserialdate031guiling() {
    let canId = [0x03,0x01];  
    let data = [0x00, 0x00, 0x00, 0x00];  

let speedValue = parseInt(variables.expectedSpeed, 10) + 3200;
let speedhexValue = speedValue.toString(16).padStart(4, '0'); 


    let torqueValue1 = variables.expectAcceleration* 10;  
       let torqueValue = parseInt(torqueValue1, 10);  
 
  
    let torquehexValue = torqueValue.toString(16).padStart(2, '0'); 

    data[0]=0X01;
    // 根据状态设置 data[0]

    data[1] = parseInt(speedhexValue.slice(0, 2), 16);  // 获取低字节
    data[2] = parseInt(speedhexValue.slice(2, 4), 16);  // 获取高字节
    data[3] = parseInt(torquehexValue.slice(0, 2), 16);  // 获取高字节



  sendRS485(canId, data);  

  
            addSendData(
      "0x" + canId.toString(16).toUpperCase(),
      data.map(d => "0x" + d.toString(16).toUpperCase()),
      ` 设定速度: ${variables.expectedSpeed}, 设定转矩: ${variables.expectAcceleration}`,
      formatTime(new Date())
    );
  
}

        //0x101编码、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、
    function sendserialdate101yuandian()
    {
        let canId = [0x01, 0x01]; 
        let data = [0x00, 0x00,0x00,0x00]; 
         
        let hexValue1 =  variables.expectedDistance+34;
 
        let hexValue =  (hexValue1*100).toString(16).padStart(8, '0');  // 转换为十六进制并确保是 8 位
   

    data = [
        parseInt(hexValue.slice(6, 8), 16),   // 低字节
        parseInt(hexValue.slice(4, 6), 16),   // 第二字节
        parseInt(hexValue.slice(2, 4), 16),   // 第三字节
        parseInt(hexValue.slice(0, 2), 16)    // 高字节
    ];

                sendRS485(canId, data);
          


addSendData(
  "0x" + canId.toString(16).toUpperCase(), // ID
  data.map(d => "0x" + d.toString(16).toUpperCase()), // data 字符串数组
  `当前设定位置:\n${variables.expectedDistance}`, // ✅ 正确换行
  formatTime(new Date()) // 当前时间
);

            // 更新上次发送的数据


    }





function sendserialdate031fu() {
    let canId =[0x00, 0x31]; 
    let data = [0x00, 0x00, 0x00, 0x00];  

let speedValue = parseInt(-variables.expectedSpeed, 10) + 3200;
let speedhexValue = speedValue.toString(16).padStart(4, '0'); 




  
    let torqueValue1 = variables.expectAcceleration* 10;  
       let torqueValue = parseInt(torqueValue1, 10);  
 
  
    let torquehexValue = torqueValue.toString(16).padStart(2, '0'); 

    data[0]=0X01;
    // 根据状态设置 data[0]

    data[1] = parseInt(speedhexValue.slice(0, 2), 16);  // 获取低字节
    data[2] = parseInt(speedhexValue.slice(2, 4), 16);  // 获取高字节
    data[3] = parseInt(torquehexValue.slice(0, 2), 16);  // 获取高字节





            sendRS485(canId, data);  
      
            addSendData(
      "0x" + canId.toString(16).toUpperCase(),
      data.map(d => "0x" + d.toString(16).toUpperCase()),
      ` 设定速度: ${-variables.expectedSpeed}, 设定转矩: ${variables.expectAcceleration}`,
      formatTime(new Date())
    );
  
    
}



    function sendserialdate101fuzhi(data)
    {

    
         let canId = [0x03, 0x01]; 
         
  if (JSON.stringify(data) !== JSON.stringify(lastSentData101fuzhi)) {

    variables.shiyanlaihui=variables.shiyanlaihui+0.5;
        document.getElementById('acceleration-inputlaihui').innerText = variables.shiyanlaihui;
         console.log("当前来回已更新为: " + variables.shiyanlaihui);

    
            sendRS485(canId, data);  
        
            addSendData(
      "0x" + canId.toString(16).toUpperCase(),
      data.map(d => "0x" + d.toString(16).toUpperCase()),
      ` 设定速度: ${variables.expectedSpeed}, 设定转矩: ${variables.expectAcceleration}`,
      formatTime(new Date())
    );
  
        lastSentData101fuzhi = [...data];
    }
}


    





function sendserialdate031zero() {
       let canId = [0x03,0x01];  
    let data = [0x00, 0x00, 0x00, 0x00];  

let speedValue = parseInt(0, 10) + 3200;
let speedhexValue = speedValue.toString(16).padStart(4, '0'); 




  
    let torqueValue1 = variables.expectAcceleration* 10;  
       let torqueValue = parseInt(torqueValue1, 10);  
 
  
    let torquehexValue = torqueValue.toString(16).padStart(2, '0'); 

    data[0]=0X01;
    // 根据状态设置 data[0]

    data[1] = parseInt(speedhexValue.slice(0, 2), 16);  // 获取低字节
    data[2] = parseInt(speedhexValue.slice(2, 4), 16);  // 获取高字节
    data[3] = parseInt(torquehexValue.slice(0, 2), 16);  // 获取高字节


   
            sendRS485(canId, data);  
      
            addSendData(
      "0x" + canId.toString(16).toUpperCase(),
      data.map(d => "0x" + d.toString(16).toUpperCase()),
      ` 设定速度: ${0}, 设定转矩: ${variables.expectAcceleration}`,
      formatTime(new Date())
    );
  

}






function sendserialdate031() {
    let canId = [0x03,0x01];  
    let data = [0x00, 0x00, 0x00, 0x00];  

let speedValue = parseInt(variables.expectedSpeed, 10) + 3200;
let speedhexValue = speedValue.toString(16).padStart(4, '0'); 


    let torqueValue1 = variables.expectAcceleration* 10;  
       let torqueValue = parseInt(torqueValue1, 10);  
 
  
    let torquehexValue = torqueValue.toString(16).padStart(2, '0'); 

    data[0]=0X01;
    // 根据状态设置 data[0]

    data[1] = parseInt(speedhexValue.slice(0, 2), 16);  // 获取低字节
    data[2] = parseInt(speedhexValue.slice(2, 4), 16);  // 获取高字节
    data[3] = parseInt(torquehexValue.slice(0, 2), 16);  // 获取高字节


  if (JSON.stringify(data) !== JSON.stringify(lastSentData031)) {



           sendRS485(canId, data);  
            addSendData(
      "0x" + canId.toString(16).toUpperCase(),
      data.map(d => "0x" + d.toString(16).toUpperCase()),
      ` 设定速度: ${variables.expectedSpeed}, 设定转矩: ${variables.expectAcceleration}`,
      formatTime(new Date())
    );
  
        lastSentData031 = [...data];
    }
        
     

}






function sendceshi() {
    let canId = [0x03,0x01];  
    let data = [0x00, 0x00, 0x00, 0x00];  


            sendRS485(canId, data);  
     

}






// document.addEventListener("DOMContentLoaded", function() {
//   document.getElementById("tongxun").style.display = "block";
// });

document.addEventListener("DOMContentLoaded", function() {
  const tongxunDiv = document.getElementById("tongxun");
  const btn = document.getElementById("export-button2");

  btn.addEventListener("click", function(){
    if (tongxunDiv.style.display === "none" || tongxunDiv.style.display === "") {
      tongxunDiv.style.display = "block";
    } else {
      tongxunDiv.style.display = "none";
    }
  });
});









    function updatecandate(){
        if (runStatus === "启动")
    {
    
            
            sendserialdate011();


          if(currentMode === '位置')
            {
        sendserialdate101();
            }
        
            // sendcandate011suanfa();


            if(currentMode === '速度')
            {
            sendserialdate031();
            }

            // sendserialdate011yuandian();
            // // sendcandate011suanfa();
            // sendserialdate031();
      

    }
    }   

let lastReceivedId485 = null;  // 确保变量初始化
let lastReceivedData485 = null;
let lastGoodTime485 = 0;
let lastSent485Data = null;  // 保存上次发送的数据
let lastSent485Data1 = { id: null, data: [] }; // 初始化 lastSent485Data1 为一个包含 id 和 data 的对象

  sendserialdate011close();
























let isSending = false; // 用于检查是否正在发送数据，避免请求积压


// 发送 RS485 数据的函数
async function sendRS485(id, data) {
    if (isSending) {
        console.log("上一个请求还未完成，跳过当前发送");
        return;  // 如果正在发送数据，跳过当前发送
    }

    isSending = true; // 设置为发送中

    console.log("发送的数据:", {
        id: `0x${id.toString(16).toUpperCase()}`,
        data: data.map(byte => `0x${byte.toString(16).padStart(2, '0').toUpperCase()}`)
    });

    const frameStart = 0xAA;
    const frameEnd = [0x00, 0x55];
    const checksum = calculateChecksum(data);

    const dataFrame = [
        frameStart,
        data.length + 2,  // 数据长度（包括 ID 和校验位）
        id[0],  // ID 高字节
        id[1],  // ID 低字节
        ...data,  // 数据部分
    //    checksum,  // 校验位
        ...frameEnd  // 终止位
    ];

    try {
        await new Promise(resolve => setTimeout(resolve, 50)); // 延迟 100ms，避免发送过快

        const response = await fetch("http://localhost:8080/send_rs485", {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, data: dataFrame })
        });

        const text = await response.text();  // 获取响应文本
        console.log("Response text:", text);

        const result = text ? JSON.parse(text) : {};

        if (response.ok) {
            console.log("RS485 信号发送成功", result);
        } else {
            console.error("RS485 信号发送失败", result);
        }
    } catch (error) {
        console.error("发送失败:", error);
    } finally {
        isSending = false; // 发送完成，重置标志
    }
}

// 接收 RS485 数据的函数

let isReceiving = false;  // 控制是否正在接收数据，防止重复请求

async function receiveRS485() {
    if (isReceiving) {
        console.log("上一个请求还未完成，跳过当前接收");
        return;  // 如果正在接收数据，跳过当前接收
    }

    isReceiving = true; // 设置为接收中

    try {
        // 发起请求获取数据
        const response = await fetch("http://localhost:8080/receive_rs485", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
        });

        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.statusText}`);
        }

        // 解析返回的 JSON 数据
        const result = await response.json();
        console.log("Received RS485 data:", result);

        // 判断接收到的 id 是否为 0，表示无效数据
        if (result.id === 0) {
            console.log("尚未接收到有效的 RS485 数据");
            return;  // 如果 id 为 0，表示没有接收到有效数据
        }


             lastGoodTime = Date.now();
        lastGoodTime485 = Date.now();
        updateConnectionStatus(true);
        // 比较数据是否发生变化，避免重复处理
        if (result.id === lastReceivedId485 && JSON.stringify(result.data) === JSON.stringify(lastReceivedData485)) {
            console.log("数据未发生变化，跳过更新");
            return;  // 数据没有变化，跳过处理
        }

        // 更新 lastReceivedId 和 lastReceivedData

        lastReceivedId485 = result.id;
        lastReceivedData485 = result.data;
   
        // 从数据中解析 ID（从第3字节和第4字节合成 ID）
        const id = (result.data[2] << 8) | result.data[3];
        console.log("Received ID (Hex): 0x" + id.toString(16).toUpperCase());

        // 提取数据部分（从第5字节开始）
        const dataPart = result.data.slice(4, result.data.length );  // 去掉 '00 55'

        // 打印数据部分为十六进制
        const hexData = dataPart.map(byte => `0x${byte.toString(16).padStart(2, '0').toUpperCase()}`).join(' ');
        console.log("Received data (Hex):", hexData);

        // 根据 id 解析数据
        if (id === 0x012) {
            let tempDistance = 0;
            let tempSpeed = 0;

            // 将小端字节数据转为 32 位有符号整数
            tempDistance = (dataPart[0]) | (dataPart[1] << 8) | (dataPart[2] << 16) | (dataPart[3] << 24);
            let raw = (dataPart[4]) | (dataPart[5] << 8);  // 0–65535

            // 检查是否负数
            if (raw & 0x8000) {
                raw = raw - 0x10000;
            }
            tempSpeed = raw;

            variables.ActualSpeed = tempSpeed;
            let nowexpectedDistance = tempDistance / 100.0;
            variables.nowexpectedDistance = nowexpectedDistance - 32;

            // 限位警报解析
            variables.limitAlarm = result.data[6];  // 0:未限位, 1:伸出限位, 2:缩回限位

            // 打印解析后的文本
            const parsed = `距离: ${(variables.nowexpectedDistance).toFixed(2)} mm, 速度: ${variables.ActualSpeed} rpm, 限位: ${variables.limitAlarm}`;
            console.log(parsed);

            addReceiveData(
                "0x" + id.toString(16).toUpperCase(),
                dataPart,  // 保留原始数据格式
                parsed,
                formatTime(new Date())
            );

        } else if (id === 0x032) {

            const rpmHigh = dataPart[0];
            const rpmLow = dataPart[1];
            variables.Actualtorque = dataPart[2] / 10; // 实际扭矩*10 Nm
            variables.errorbit = dataPart[3]; // 故障位
            variables.Actualcurrent = dataPart[4] * 10; // 电流峰值*10 A
            const voltageHigh = dataPart[5];
            const voltageLow = dataPart[6];

            variables.ActualRotationalspeed = (rpmHigh * 256) + rpmLow - 3200;  // 合并转速高位和低位
            variables.Actualpower=(voltageHigh * 256) + voltageLow;
            // 打印故障位
            console.log("Error bits:", variables.errorbit);

            // 检查每个故障位并打印
                    // if (variables.errorbit & 0x01) { // 位0: 过流保护
                    //  addFaultLog("推杆01号", "高", "电机过流", formatTime(new Date()));
                    //  }

                    //  if (variables.errorbit & 0x02) { // 位1: 过载保护
                    //  addFaultLog("推杆01号", "高", "电机过载", formatTime(new Date()));
                    //  }

                    //  if (variables.errorbit & 0x04) { // 位2: 电机过温报警
                    //  addFaultLog("推杆01号", "高", "电机即将过温", formatTime(new Date()));
                    //  }

                    //  if (variables.errorbit & 0x08) { // 位3: 驱动器过温报警
                    //  addFaultLog("推杆01号", "高", "电机过温", formatTime(new Date()));
                    // }

            // 构造限位状态文本
            const parsed = `转速: ${variables.ActualRotationalspeed} rpm, 扭矩: ${variables.Actualtorque.toFixed(1)} Nm, 电流: ${variables.Actualcurrent.toFixed(1)} A,, 温度: ${variables.Actualpower.toString(16)} A 故障位: ${variables.errorbit}`;

            // 打印构造后的文本
            console.log(parsed);

            addReceiveData(
                "0x" + id.toString(16).toUpperCase(),
                dataPart,  // 保留原始数据格式
                parsed,
                formatTime(new Date())
            );
        }

    } catch (error) {
        console.error("Error fetching RS485 data:", error);
    } finally {
        isReceiving = false;  // 接收完成，重置标志
    }
}


// 每 500ms 接收一次数据
function startReceiveAndSend() {
    setInterval(function() {
        receiveRS485();  // 调用接收函数
    }, 30); // 调整接收频率为每 500ms 一次

    // setInterval(function() {
    //     sendRS485([0x01, 0x02], [0xAA, 0xBB, 0xCC]);  // 示例数据
    // }, 1000); // 调整发送频率为每 500ms 一次
}
startReceiveAndSend();

// 计算校验和（XOR 校验）
function calculateChecksum(data) {
    return data.reduce((checksum, byte) => checksum ^ byte, 0);
}















  myChart.getDom().addEventListener('contextmenu', function (e) {
    e.preventDefault(); // 阻止右键菜单
    myChart.dispatchAction({
        type: 'restore'  // 触发还原功能
    });
});





myChart2.getDom().addEventListener('contextmenu', function (e) {
    e.preventDefault(); // 阻止右键菜单
    myChart2.dispatchAction({
        type: 'restore'  // 触发还原功能
    });
});



window.onbeforeunload = function(event) {
    console.log("页面关闭前执行的操作");
    sendserialdate011close();
    return "网页关闭，已发送停止信号";
};







</script>




</body>
</html>